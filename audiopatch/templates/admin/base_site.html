{% extends "admin/base.html" %}

{% block extrahead %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Global spreadsheet navigation loading...');
    
    // Only run on change forms
    if (!document.body.classList.contains('change-form')) {
        console.log('Not a change form, skipping navigation');
        return;
    }
    
    // Override form submission on Enter key
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('keypress', function(e) {
            // If Enter is pressed on an input field (not button/submit)
            if (e.key === 'Enter' && 
                e.target.tagName !== 'TEXTAREA' &&
                e.target.type !== 'submit' &&
                e.target.type !== 'button') {
                
                e.preventDefault();
                e.stopPropagation();
                
                // Get all focusable elements
                const inputs = Array.from(form.querySelectorAll(
                    'input:not([type="hidden"]):not([readonly]):not([disabled]):not([type="submit"]):not([type="button"]), ' +
                    'select:not([disabled]), ' +
                    'textarea:not([readonly]):not([disabled])'
                )).filter(el => el.offsetParent !== null);
                
                const current = inputs.indexOf(e.target);
                if (current === -1) return false;
                
                // Calculate next index
                let next;
                if (e.shiftKey) {
                    next = current - 1;
                    if (next < 0) next = inputs.length - 1;
                } else {
                    next = current + 1;
                    if (next >= inputs.length) next = 0;
                }
                
                // Focus next element
                if (inputs[next]) {
                    inputs[next].focus();
                    if (inputs[next].select && inputs[next].type !== 'select-one') {
                        setTimeout(() => inputs[next].select(), 10);
                    }
                }
                
                return false;
            }
        });
    });
    
    console.log('Spreadsheet navigation active - Enter: next field, Shift+Enter: previous field');
});
</script>
{% endblock %}