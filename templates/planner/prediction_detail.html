{% extends 'admin/base_site.html' %}
{% load humanize %}

{% block title %}{{ prediction.file_name }} - Soundvision Prediction{% endblock %}

{% block content %}
<div class="prediction-detail">
    <div class="page-header">
        <h1>{{ prediction.file_name }}</h1>
        <div class="header-meta">
            <span class="meta-item">Version: {{ prediction.version }}</span>
            <span class="meta-item">Generated: {{ prediction.date_generated }}</span>
            <span class="meta-item">Total Arrays: {{ total_arrays }}</span>
            <span class="meta-item">Total Weight: {{ total_weight|floatformat:0|intcomma }} lbs</span>
        </div>
    </div>

    <div class="controls">
        <button type="button" class="btn btn-secondary" onclick="expandAll()">Expand All</button>
        <button type="button" class="btn btn-secondary" onclick="collapseAll()">Collapse All</button>
        <a href="{% url 'planner:export_prediction' prediction.pk %}" class="btn btn-primary">Export CSV</a>
    </div>

    {% for group_name, array_groups in grouped_arrays.items %}
    <div class="soundvision-group">
        <h2 class="group-header" onclick="toggleGroup('group-{{ forloop.counter }}')">
            <span class="toggle-icon">▼</span>
            {{ group_name }}
            <span class="group-meta">
                {% with array_groups.values|length as array_type_count %}
                {{ array_type_count }} array type{{ array_type_count|pluralize }}
                {% endwith %}
            </span>
        </h2>
        
        <div id="group-{{ forloop.counter }}" class="group-content">
            {% for base_name, arrays in array_groups.items %}
            <div class="array-group">
                <div class="array-header" onclick="toggleArray('array-{{ forloop.parentloop.counter }}-{{ forloop.counter }}')">
                    <span class="toggle-icon">▶</span>
                    <span class="array-name">{{ base_name }}</span>
                    <span class="array-count">{{ arrays|length }} array{{ arrays|length|pluralize }}</span>
                    
                    {% with arrays.0 as first_array %}
                    <div class="array-badges">
                        <span class="badge badge-weight">{{ first_array.total_weight_lb|floatformat:0 }} lbs</span>
                        <span class="badge badge-trim">Trim: {{ first_array.bottom_elevation|floatformat:0 }}'</span>
                        <span class="badge badge-count">{{ first_array.cabinets.count }} boxes</span>
                        {% if first_array.mbar_hole %}
                        <span class="badge badge-mbar">MBar {{ first_array.mbar_hole }}</span>
                        {% endif %}
                    </div>
                    {% endwith %}
                </div>
                
                <div id="array-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="array-content" style="display: none;">
                    {% for array in arrays %}
                    <div class="array-instance">
                        <div class="instance-header">
                            <strong>{{ array.display_name }}</strong>
                            <span class="position-info">
                                Position: ({{ array.position_x|floatformat:2 }}, {{ array.position_y|floatformat:2 }}, {{ array.position_z|floatformat:2 }})
                            </span>
                        </div>
                        
                        <div class="instance-details">
                            <div class="detail-row">
                                <span class="detail-label">Configuration:</span>
                                <span class="detail-value">{{ array.get_configuration_display }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bumper:</span>
                                <span class="detail-value">{{ array.bumper_type }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Motors:</span>
                                <span class="detail-value">{{ array.num_motors }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Total Weight:</span>
                                <span class="detail-value">{{ array.total_weight_lb|floatformat:2 }} lbs</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bottom Trim:</span>
                                <span class="detail-value">{{ array.bottom_elevation|floatformat:2 }}'</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Site Angle:</span>
                                <span class="detail-value">{{ array.site_angle }}°</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Azimuth:</span>
                                <span class="detail-value">{{ array.azimuth }}°</span>
                            </div>
                            {% if array.front_pickup_position %}
                            <div class="detail-row">
                                <span class="detail-label">Front Pickup (Hole):</span>
                                <span class="detail-value">{{ array.front_pickup_position }}</span>
                            </div>
                            {% endif %}
                            {% if array.rear_pickup_position %}
                            <div class="detail-row">
                                <span class="detail-label">Rear Pickup:</span>
                                <span class="detail-value">{{ array.rear_pickup_position }}</span>
                            </div>
                            {% endif %}
                            {% if array.front_motor_load_lb %}
                            <div class="detail-row">
                                <span class="detail-label">Front Motor Load:</span>
                                <span class="detail-value">{{ array.front_motor_load_lb|floatformat:2 }} lbs</span>
                            </div>
                            {% endif %}
                            {% if array.rear_motor_load_lb %}
                            <div class="detail-row">
                                <span class="detail-label">Rear Motor Load:</span>
                                <span class="detail-value">{{ array.rear_motor_load_lb|floatformat:2 }} lbs</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if array.cabinets.exists %}
                        <div class="cabinet-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Model</th>
                                        <th>Angle</th>
                                        <th>Site</th>
                                        <th>Top Z</th>
                                        <th>Bottom Z</th>
                                        {% if array.cabinets.first.panflex_setting %}
                                        <th>Panflex</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cabinet in array.cabinets.all %}
                                    <tr>
                                        <td>{{ cabinet.position_number }}</td>
                                        <td>{{ cabinet.speaker_model }}</td>
                                        <td>{% if cabinet.angle_to_next is not None %}{{ cabinet.angle_to_next }}°{% else %}-{% endif %}</td>
                                        <td>{{ cabinet.site_angle }}°</td>
                                        <td>{{ cabinet.top_z }}'</td>
                                        <td>{{ cabinet.bottom_z }}'</td>
                                        {% if array.cabinets.first.panflex_setting %}
                                        <td>{{ cabinet.panflex_setting }}</td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
/* Force dark theme on body and override any base template styles */
html, body {
    background: #1a1a1a !important;
    color: #fff !important;
    margin: 0;
    padding: 0;
}

/* Hide the Tailwind test div from base.html */
.bg-blue-200 {
    display: none !important;
}

/* Dark navbar override */
.navbar {
    background: #252525 !important;
    padding: 10px 20px;
    border-bottom: 1px solid #333;
}

.navbar a {
    color: #4a9eff !important;
    text-decoration: none;
    margin-right: 20px;
}

.navbar a:hover {
    color: #6ab4ff !important;
}

.prediction-detail {
    padding: 20px;
    background: #1a1a1a;
    min-height: 100vh;
}

.page-header {
    margin-bottom: 20px;
}

.page-header h1 {
    margin-bottom: 10px;
    color: #fff;
}

.header-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    color: #aaa;
}

.meta-item {
    padding: 6px 12px;
    background: #2a2a2a;
    border-radius: 4px;
    font-size: 14px;
}

.controls {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
}

.btn-secondary {
    background: #3a3a3a;
    color: #fff;
}

.btn-secondary:hover {
    background: #4a4a4a;
}

.btn-primary {
    background: #4a9eff;
    color: #fff;
}

.btn-primary:hover {
    background: #3a8eef;
}

/* Soundvision Group (top level - e.g., "KARA Mains", "Delay") */
.soundvision-group {
    margin-bottom: 20px;
    background: #1e1e1e;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #333;
}

.group-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    background: #2a2a2a;
    cursor: pointer;
    color: #fff;
    font-size: 18px;
    margin: 0;
    border-bottom: 1px solid #3a3a3a;
    user-select: none;
}

.group-header:hover {
    background: #333;
}

.group-header .toggle-icon {
    font-size: 12px;
    transition: transform 0.2s;
    width: 16px;
}

.group-header.collapsed .toggle-icon {
    transform: rotate(-90deg);
}

.group-meta {
    margin-left: auto;
    font-size: 14px;
    color: #888;
    font-weight: normal;
}

.group-content {
    padding: 10px;
    background: #1e1e1e;
}

/* Array Group (second level - e.g., "KARA II 1", "KARA II 2") */
.array-group {
    margin-bottom: 10px;
    background: #252525;
    border-radius: 6px;
    overflow: hidden;
}

.array-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background: #2d2d2d;
    cursor: pointer;
    color: #fff;
    user-select: none;
}

.array-header:hover {
    background: #353535;
}

.array-header .toggle-icon {
    font-size: 10px;
    color: #888;
    width: 12px;
}

.array-name {
    font-weight: 600;
}

.array-count {
    color: #888;
    font-size: 13px;
}

.array-badges {
    margin-left: auto;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.badge-weight {
    background: #2d4a2d;
    color: #8f8;
}

.badge-trim {
    background: #2d2d4a;
    color: #88f;
}

.badge-count {
    background: #4a2d2d;
    color: #f88;
}

.badge-mbar {
    background: #4a4a2d;
    color: #ff8;
}

.array-content {
    padding: 15px;
    background: #222;
}

/* Array Instance (individual arrays within a group) */
.array-instance {
    margin-bottom: 15px;
    padding: 15px;
    background: #1a1a1a;
    border-radius: 6px;
    border-left: 3px solid #4a9eff;
}

.array-instance:last-child {
    margin-bottom: 0;
}

.instance-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #333;
    flex-wrap: wrap;
    gap: 10px;
}

.instance-header strong {
    color: #4a9eff;
    font-size: 16px;
}

.position-info {
    color: #888;
    font-size: 13px;
}

.instance-details {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px;
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 10px;
    background: #252525;
    border-radius: 4px;
}

.detail-label {
    color: #888;
    font-size: 13px;
}

.detail-value {
    color: #fff;
    font-weight: 500;
    font-size: 13px;
}

.cabinet-table {
    overflow-x: auto;
}

.cabinet-table table {
    width: 100%;
    border-collapse: collapse;
}

.cabinet-table th,
.cabinet-table td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid #333;
}

.cabinet-table th {
    background: #2a2a2a;
    color: #888;
    font-weight: 500;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
}

.cabinet-table td {
    color: #fff;
    font-size: 13px;
}

.cabinet-table tbody tr:hover td {
    background: #2a2a2a;
}

/* Hide sidebar from base if present */
.sidebar {
    display: none !important;
}

.main {
    margin-left: 0 !important;
    padding: 0 !important;
}

.container {
    max-width: none !important;
    padding: 0 !important;
}
</style>

<script>
function toggleGroup(groupId) {
    const content = document.getElementById(groupId);
    const header = content.previousElementSibling;
    const icon = header.querySelector('.toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        header.classList.remove('collapsed');
        icon.textContent = '▼';
    } else {
        content.style.display = 'none';
        header.classList.add('collapsed');
        icon.textContent = '▶';
    }
}

function toggleArray(arrayId) {
    const content = document.getElementById(arrayId);
    const header = content.previousElementSibling;
    const icon = header.querySelector('.toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼';
    } else {
        content.style.display = 'none';
        icon.textContent = '▶';
    }
}

function expandAll() {
    // Expand all groups
    document.querySelectorAll('.group-content').forEach(el => {
        el.style.display = 'block';
        const header = el.previousElementSibling;
        header.classList.remove('collapsed');
        const icon = header.querySelector('.toggle-icon');
        if (icon) icon.textContent = '▼';
    });
    
    // Expand all arrays
    document.querySelectorAll('.array-content').forEach(el => {
        el.style.display = 'block';
        const icon = el.previousElementSibling.querySelector('.toggle-icon');
        if (icon) icon.textContent = '▼';
    });
}

function collapseAll() {
    // Collapse all groups
    document.querySelectorAll('.group-content').forEach(el => {
        el.style.display = 'none';
        const header = el.previousElementSibling;
        header.classList.add('collapsed');
        const icon = header.querySelector('.toggle-icon');
        if (icon) icon.textContent = '▶';
    });
    
    // Collapse all arrays
    document.querySelectorAll('.array-content').forEach(el => {
        el.style.display = 'none';
        const icon = el.previousElementSibling.querySelector('.toggle-icon');
        if (icon) icon.textContent = '▶';
    });
}
</script>
{% endblock %}