<!-- planner/templates/planner/mic_tracker.html -->
{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Mic Tracker - {{ show_info.show_name|default:"Audio Patch" }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/mic_tracker.css' %}">
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script src="{% static 'admin/js/jquery.init.js' %}"></script>
{% endblock %}

{% block content %}
<div id="mic-tracker-container">
    <!-- Header Section -->
    <div class="mic-tracker-header">
        <h1>Mic Assignment Tracker</h1>
        
        <div class="show-info">
            <div class="info-row">
                <span class="label">Show:</span>
                <span class="value">{{ show_info.show_name|default:"--" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Venue:</span>
                <span class="value">{{ show_info.venue_name|default:"--" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Ballroom:</span>
                <span class="value">{{ show_info.ballroom_name|default:"--" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Duration:</span>
                <span class="value">{{ show_info.duration_display|default:"--" }}</span>
            </div>
        </div>
        
        <div class="tracker-actions">
            {% if not is_viewer %}
            <button class="btn btn-primary" onclick="addNewDay()">Add Day</button>
            {% endif %}

            <a href="/audiopatch/mic-tracker/export/" class="btn btn-export">Export CSV</a>
        </div>

    <!-- Days Container -->
    <div class="days-container">
        {% for day_data in days_data %}
        <div class="day-section" data-day-id="{{ day_data.day.id }}" data-collapsed="{{ day_data.day.is_collapsed|yesno:'true,false' }}">
            <div class="day-header" onclick="toggleDay({{ day_data.day.id }})">
                <span class="collapse-icon">{% if day_data.day.is_collapsed %}‚ñ∂{% else %}‚ñº{% endif %}</span>
                <h2>{{ day_data.day }}</h2>
                <div class="day-stats">
                    {% with stats=day_data.day.get_all_mics_status %}
                    <span class="stat">Sessions: {{ day_data.day.sessions.count }}</span>
                    <span class="stat">Mics: {{ stats.used }}/{{ stats.total }}</span>
                    <span class="stat">Available: {{ stats.available }}</span>
                    {% endwith %}
                </div>
                <div class="day-actions">
                    {% if not is_viewer %}
                    <button class="btn btn-sm" onclick="event.stopPropagation(); addSession({{ day_data.day.id }})">Add Session</button>
                    {% endif %}
                </div>
            </div>
            
            <div class="day-content" {% if day_data.day.is_collapsed %}style="display: none;"{% endif %}>
                <div class="sessions-grid">
                    {% for session in day_data.sessions %}
                        {% if forloop.counter0|divisibleby:3 %}
                            {% if not forloop.first %}</div>{% endif %}
                            <div class="session-row">
                        {% endif %}
                        
                        <div class="session-column" data-session-id="{{ session.id }}">
                            <div class="session-header">
                                <div class="session-info">
                                    <span class="session-date">{{ session.day.date|date:"m/d" }}</span>
                                    <h3>{{ session.name }}</h3>
                                    {% if session.location %}
                                    <span class="session-location">{{ session.location }}</span>
                                    {% endif %}
                                </div>
                                <div class="session-actions">
                                    {% if not is_viewer %}
                                    <button class="btn-icon" title="Duplicate" onclick="duplicateSession({{ session.id }})">üìã</button>
                                    <button class="btn-icon" title="Settings" onclick="editSession({{ session.id }})">‚öôÔ∏è</button>
                                    <div class="dropdown">
                                        <button class="btn-icon" title="Bulk Actions">‚ãÆ</button>
                                        <div class="dropdown-content">
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'check_all_micd'); return false;">Check All MIC'D</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'uncheck_all_micd'); return false;">Uncheck All MIC'D</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'check_all_dmic'); return false;">Check All D-MIC</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'uncheck_all_dmic'); return false;">Uncheck All D-MIC</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'clear_all'); return false;">Clear All</a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div> 
                            
                            <div class="mic-grid">
                                <div class="mic-grid-header">
                                    <div class="col-rf">RF#</div>
                                    <div class="col-type">TYPE</div>
                                    <div class="col-presenter">PRESENTER</div>
                                    <div class="col-micd">MIC'D</div>
                                    <div class="col-dmic">D-MIC</div>
                                </div>
                                
                                {% for assignment in session.mic_assignments.all %}
                                <div class="mic-row {% if assignment.is_micd %}is-micd{% endif %}" data-assignment-id="{{ assignment.id }}">
                                    <div class="col-rf">{{ assignment.rf_number|stringformat:"02d" }}</div>
                                    
                                    <div class="col-type">
                                        <select class="mic-type-select" onchange="updateField({{ assignment.id }}, 'mic_type', this.value)" {% if is_viewer %}disabled{% endif %}>
                                            <option value="">---</option>
                                            {% for value, label in mic_types %}
                                            {% if value %}
                                            <option value="{{ value }}" {% if assignment.mic_type == value %}selected{% endif %}>{{ label }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-presenter">
                                        <!-- Primary Presenter Row -->
                                        <div class="presenter-row primary-presenter">
                                            <span class="presenter-order">1¬∞</span>
                                            <input type="text" 
                                                    class="presenter-input {% if assignment.active_presenter_index == 0 %}active-presenter{% endif %}" 
                                                    value="{% if assignment.presenter %}{{ assignment.presenter.name }}{% endif %}"
                                                    placeholder="Enter name..."
                                                    list="presenters-datalist"
                                                    onchange="updateField({{ assignment.id }}, 'presenter', this.value)"
                                                    title="Primary presenter"
                                                    {% if is_viewer %}readonly{% endif %}>

                                            {% if not is_viewer %}
                                            <!-- Add Shared Presenter Button -->
                                            <button type="button" 
                                                    class="btn-add-shared" 
                                                    onclick="togglePresenters({{ assignment.id }})"
                                                    title="Add shared presenter">
                                                +
                                            </button>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Shared Presenters Section - Always render, hide if empty -->
                                        <div class="shared-presenters-container" 
                                            data-assignment-id="{{ assignment.id }}"
                                            style="{% if not assignment.shared_presenters.exists %}display: none;{% endif %}">
                                            
                                            {% for shared in assignment.ordered_shared_presenters %}
                                            <div class="presenter-row shared-presenter" data-presenter-name="{{ shared.name }}">
                                                <span class="presenter-order">{{ forloop.counter|add:"1" }}¬∞</span>
                                                <input type="text" 
                                                    class="presenter-input {% if assignment.active_presenter_index == forloop.counter %}active-presenter{% endif %}" 
                                                    value="{{ shared.name }}"
                                                    readonly
                                                    title="Shared presenter #{{ forloop.counter|add:"1" }}">
                                                {% if assignment.active_presenter_index == forloop.counter %}
                                                <span class="current-badge">CURRENT</span>
                                                {% endif %}
                                                {% if not is_viewer %}
                                                <button type="button" 
                                                        class="btn-remove-presenter" 
                                                        onclick="removeSharedPresenter({{ assignment.id }}, '{{ shared.name }}')"
                                                        title="Remove presenter">
                                                    √ó
                                                </button>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                            
                                            <!-- Add New Presenter Form -->
                                            {% if not is_viewer %}
                                            <div class="add-presenter-row">
                                                <input type="text" 
                                                        class="presenter-input add-presenter-input" 
                                                        placeholder="Add presenter..."
                                                        id="newPresenter_{{ assignment.id }}"
                                                        list="presenters-datalist"
                                                        onkeypress="if(event.key === 'Enter') addSharedPresenterInline({{ assignment.id }})">
                                                <button type="button" 
                                                        class="btn-add-inline" 
                                                        onclick="addSharedPresenterInline({{ assignment.id }})"
                                                        title="Add presenter">
                                                    +
                                                </button>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Reset Button (only show if not on primary) -->
                                            {% if assignment.active_presenter_index > 0 %}
                                            <div class="reset-row">
                                                <button type="button" 
                                                        class="btn-reset-rotation" 
                                                        onclick="resetPresenterRotation({{ assignment.id }})"
                                                        title="Reset to primary presenter">
                                                    ‚Ü∫ Reset to Primary
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-micd">
                                        <input type="checkbox" 
                                            class="mic-checkbox"
                                            {% if assignment.is_micd %}checked{% endif %}
                                            onchange="updateField({{ assignment.id }}, 'is_micd', this.checked)"
                                            {% if is_viewer %}disabled{% endif %}>
                                    </div>

                                    <div class="col-dmic">
                                        <input type="checkbox" 
                                            class="mic-checkbox dmic-checkbox"
                                            {% if assignment.is_d_mic %}checked{% endif %}
                                            onchange="handleDmicChange({{ assignment.id }}, this.checked)"
                                            {% if is_viewer %}disabled{% endif %}>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="session-footer">
                                {% with stats=session.get_mic_usage_stats %}
                                <span class="session-stat">MIC'D: {{ stats.micd }}/{{ stats.total }}</span>
                                <span class="session-stat">Available: {{ stats.total|add:stats.micd|stringformat:"-d" }}</span>
                                {% if stats.shared > 0 %}
                                <span class="session-stat">Shared: {{ stats.shared }}</span>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                        
                        {% if forloop.last %}</div>{% endif %}
                    {% endfor %}
                    
                    
                    
                    {% if not is_viewer %}
                        {% if not day_data.sessions %}
                            <div class="session-row">
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 0)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 1)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 2)">
                                        + Add Session
                                    </button>
                                </div>
                            </div>
                        {% elif day_data.sessions|length|divisibleby:3 %}
                            <div class="session-row">
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 0)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 1)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 2)">
                                        + Add Session
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Close the for day_data in days_data loop -->

                <!-- Shared datalist for all presenter inputs -->
                    <datalist id="presenters-datalist">
                        <!-- Will be populated by JavaScript -->
                    </datalist>

                   <script src="{% static 'admin/js/mic_tracker.js' %}"></script>
        
        <!-- Auto-refresh for collaborative editing -->
        <script>
        (function() {
            'use strict';
            
            let lastChecksum = null;
            let lastActivity = Date.now();
            let hasUnseenUpdates = false;
            const CHECK_INTERVAL = 5000; // 5 seconds
            const IDLE_THRESHOLD = 30000; // 30 seconds
            
            // Track user activity
            function updateActivity() {
                lastActivity = Date.now();
                hideUpdateBanner();
            }
            
            // Listen for user interactions
            document.addEventListener('click', updateActivity);
            document.addEventListener('keypress', updateActivity);
            document.addEventListener('input', updateActivity);
            document.addEventListener('change', updateActivity);
            
            // Create update banner
            function createBanner() {
                const banner = document.createElement('div');
                banner.id = 'mic-tracker-update-banner';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #4a9eff;
                    color: white;
                    padding: 12px;
                    text-align: center;
                    z-index: 99999;
                    display: none;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                banner.innerHTML = `
                    <strong>üîÑ Updates Available!</strong> Another user has made changes.
                    <button onclick="location.reload()" style="
                        margin-left: 15px;
                        background: white;
                        color: #4a9eff;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                        font-size: 13px;
                    ">Refresh Now</button>
                    <button onclick="document.getElementById('mic-tracker-update-banner').style.display='none'" style="
                        margin-left: 8px;
                        background: transparent;
                        color: white;
                        border: 1px solid white;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 13px;
                    ">Dismiss</button>
                `;
                document.body.insertBefore(banner, document.body.firstChild);
                return banner;
            }
            
            function showUpdateBanner() {
                let banner = document.getElementById('mic-tracker-update-banner');
                if (!banner) {
                    banner = createBanner();
                }
                banner.style.display = 'block';
                hasUnseenUpdates = true;
            }
            
            function hideUpdateBanner() {
                const banner = document.getElementById('mic-tracker-update-banner');
                if (banner) {
                    banner.style.display = 'none';
                }
                hasUnseenUpdates = false;
            }
            
            function isUserIdle() {
                return (Date.now() - lastActivity) > IDLE_THRESHOLD;
            }
            
            async function checkForUpdates() {
                try {
                    const response = await fetch('/api/mic-tracker-checksum/');
                    if (!response.ok) {
                        console.error('Mic Tracker: Checksum endpoint error', response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (!data.checksum) {
                        return;
                    }
                    
                    if (lastChecksum === null) {
                        lastChecksum = data.checksum;
                        console.log('Mic Tracker: Initial checksum stored');
                        return;
                    }
                    
                    if (data.checksum !== lastChecksum) {
                        console.log('Mic Tracker: Changes detected!');
                        lastChecksum = data.checksum;
                        
                        if (isUserIdle() && !hasUnseenUpdates) {
                            console.log('Mic Tracker: Auto-refreshing (user idle)');
                            location.reload();
                        } else {
                            console.log('Mic Tracker: Showing update banner');
                            showUpdateBanner();
                        }
                    }
                } catch (error) {
                    console.error('Mic Tracker: Error checking for updates', error);
                }
            }
            
            console.log('üîÑ Mic Tracker: Live updates enabled (checking every 5 seconds)');
            setInterval(checkForUpdates, CHECK_INTERVAL);
            setTimeout(checkForUpdates, CHECK_INTERVAL);
        })();
        </script>
        
    {% endblock %}
            