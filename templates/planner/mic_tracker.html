{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Mic Tracker - {{ show_info.show_name|default:"Audio Patch" }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
    :root {
        --bg-base:       #0f0f1a;
        --bg-card:       #181828;
        --bg-raised:     #1e1e32;
        --bg-input:      #252540;
        --border:        #2a2a45;
        --border-bright: #3a3a60;
        --accent-blue:   #4a9eff;
        --accent-green:  #00e676;
        --accent-amber:  #ffab00;
        --accent-red:    #ff5252;
        --text-primary:  #e8e8f0;
        --text-secondary:#9090b0;
        --text-dim:      #505070;
        --micd-bg:       rgba(0, 230, 118, 0.08);
        --micd-border:   rgba(0, 230, 118, 0.35);
    }

    #mic-tracker-root * { box-sizing: border-box; }
    #mic-tracker-root {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--bg-base);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 0 0 60px;
    }

    /* Page header */
    .mtt-header {
        display: flex; align-items: center; gap: 24px;
        padding: 18px 24px 14px; border-bottom: 1px solid var(--border);
        background: var(--bg-card); flex-wrap: wrap;
    }
    .mtt-title {
        font-size: 16px; font-weight: 700; letter-spacing: 0.12em;
        text-transform: uppercase; color: var(--accent-blue); white-space: nowrap;
    }
    .mtt-show-meta { display: flex; gap: 24px; flex: 1; flex-wrap: wrap; }
    .mtt-meta-item { display: flex; flex-direction: column; gap: 2px; }
    .mtt-meta-label { font-size: 9px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-dim); }
    .mtt-meta-value { font-size: 13px; color: var(--text-secondary); }
    .mtt-header-actions { display: flex; gap: 8px; align-items: center; }

    /* Buttons */
    .btn-mtt {
        padding: 7px 14px; font-size: 11px; font-weight: 600; letter-spacing: 0.08em;
        text-transform: uppercase; border-radius: 4px; border: none; cursor: pointer;
        text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
        transition: opacity 0.15s, transform 0.1s; font-family: inherit;
    }
    .btn-mtt:active { transform: scale(0.97); }
    .btn-mtt:hover { opacity: 0.85; }
    .btn-mtt-primary { background: var(--accent-blue); color: #000; }
    .btn-mtt-ghost   { background: var(--bg-raised); color: var(--text-secondary); border: 1px solid var(--border-bright); }
    .btn-mtt-export  { background: var(--bg-raised); color: var(--accent-amber); border: 1px solid rgba(255,171,0,0.3); }

    .btn-icon-sm {
        width: 28px; height: 28px; border-radius: 4px; border: 1px solid var(--border);
        background: var(--bg-raised); color: var(--text-dim); font-size: 13px; cursor: pointer;
        display: inline-flex; align-items: center; justify-content: center;
        transition: all 0.15s; text-decoration: none; padding: 0; font-family: inherit;
    }
    .btn-icon-sm:hover { border-color: var(--border-bright); color: var(--text-secondary); }

    /* Day */
    .mtt-day { margin: 16px 24px; border: 1px solid var(--border); border-radius: 6px; overflow: visible; }
    .mtt-day-header {
        display: flex; align-items: center; gap: 14px; padding: 11px 16px;
        background: var(--bg-raised); cursor: pointer; user-select: none;
    }
    .mtt-day-header:hover { background: #222238; }
    .mtt-day-collapse { font-size: 10px; color: var(--text-dim); transition: transform 0.2s; width: 12px; text-align: center; flex-shrink: 0; }
    .mtt-day-collapse.collapsed { transform: rotate(-90deg); }
    .mtt-day-name { font-size: 13px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-primary); }
    .mtt-day-stats { display: flex; gap: 16px; margin-left: auto; font-size: 11px; color: var(--text-dim); }
    .mtt-day-stats strong { color: var(--text-secondary); }
    .mtt-day-actions { display: flex; gap: 6px; }

    /* Add session footer */
    .mtt-add-session-bar {
        padding: 10px 14px;
        border-top: 1px solid var(--border);
        background: #0f0f1a;
    }

    /* Session */
    .mtt-session { margin: 14px 14px 0 14px; border: 1px solid var(--border); border-radius: 5px; overflow: visible; }

    .mtt-session-header {
        display: flex; align-items: center; gap: 10px;
        padding: 0 14px; background: #14142a;
        border-bottom: 1px solid var(--border);
        min-height: 46px; flex-wrap: wrap;
        cursor: pointer; user-select: none;
        z-index: 10;
        position: relative;
    }

    /* Session collapse arrow */
    .mtt-session-collapse {
        font-size: 10px; color: var(--text-dim);
        transition: transform 0.2s; width: 12px;
        text-align: center; flex-shrink: 0;
    }
    .mtt-session-collapse.collapsed { transform: rotate(-90deg); }

    /* Session body â€” collapses */
    .mtt-session-body { }
    .mtt-session-body.collapsed { display: none; }

    .mtt-session-date {
        font-size: 10px; color: var(--text-dim); background: var(--bg-raised);
        padding: 2px 8px; border-radius: 3px; white-space: nowrap; flex-shrink: 0;
    }
    .mtt-session-name { font-size: 13px; font-weight: 700; color: var(--text-primary); letter-spacing: 0.04em; }
    .mtt-session-loc { font-size: 11px; color: var(--text-dim); }

    /* Session A1/A2 tabs */
    .session-tabs { display: flex; height: 46px; align-items: stretch; flex-shrink: 0; margin-right: 8px; }
    .session-tab {
        height: 100%; padding: 0 22px; font-size: 15px; font-weight: 700;
        letter-spacing: 0.08em; text-transform: uppercase; border: none;
        background: transparent; color: var(--text-dim); cursor: pointer;
        border-bottom: 2px solid transparent; transition: color 0.15s, border-color 0.15s;
        font-family: inherit;
    }
    .session-tab:hover { color: var(--text-secondary); }
    .session-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }

    .session-actions {
        display: flex; gap: 4px; align-items: center;
        padding-left: 10px; border-left: 1px solid var(--border); height: 30px;
        margin-left: auto;
    }

    .session-panel { display: none; }
    .session-panel.active { display: block; }

    .mtt-session-stats {
        font-size: 10px; color: var(--text-dim); padding: 6px 14px;
        background: #0f0f1a; border-top: 1px solid var(--border);
        display: flex; gap: 16px;
    }
    .mtt-session-stats strong { color: var(--accent-green); }

    /* Dropdown */
    .mtt-dropdown { position: relative; display: inline-block; }
    .mtt-dropdown-menu {
        display: none; position: absolute; right: 0; top: 100%;
        background: var(--bg-raised); border: 1px solid var(--border-bright);
        border-radius: 4px; min-width: 185px; z-index: 200;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden;
    }
    .mtt-dropdown:hover .mtt-dropdown-menu { display: block; }
    .mtt-dropdown-menu a { display: block; padding: 8px 14px; font-size: 11px; color: var(--text-secondary); text-decoration: none; }
    .mtt-dropdown-menu a:hover { background: var(--bg-input); color: var(--text-primary); }
    .mtt-dropdown-menu .divider { height: 1px; background: var(--border); margin: 4px 0; }

    /* A1 table */
    .a1-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .a1-table thead th {
        padding: 12px 12px; font-size: 11px; font-weight: 700; letter-spacing: 0.12em;
        text-transform: uppercase; color: var(--text-secondary); background: #13131f;
        text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap;
    }
    .a1-table thead th.th-center { text-align: center; }

    .a1-row { border-bottom: 1px solid var(--border); transition: background 0.1s; }
    .a1-row:last-child { border-bottom: none; }
    .a1-row:hover { background: rgba(255,255,255,0.02); }
    .a1-row.row-micd { background: var(--micd-bg); }
    .a1-row.row-micd:hover { background: rgba(0,230,118,0.11); }
    .a1-row td { padding: 9px 12px; vertical-align: middle; }

    .a1-rf { width: 56px; font-size: 20px; font-weight: 800; color: var(--text-primary); }
    .a1-row.row-micd .a1-rf { color: var(--accent-green); }

    .mic-type-badge {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 3px 9px; border-radius: 3px; font-size: 10px;
        font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; white-space: nowrap;
    }
    .mic-type-badge .type-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .type-HH        { background: rgba(74,158,255,0.12);  color: #4a9eff; }  .type-HH       .type-dot { background: #4a9eff; }
    .type-LAV       { background: rgba(255,171,0,0.12);   color: #ffab00; }  .type-LAV      .type-dot { background: #ffab00; }
    .type-HEADSET   { background: rgba(180,100,255,0.12); color: #b464ff; }  .type-HEADSET  .type-dot { background: #b464ff; }
    .type-PODIUM    { background: rgba(0,230,118,0.12);   color: #00e676; }  .type-PODIUM   .type-dot { background: #00e676; }
    .type-BOOM      { background: rgba(255,82,82,0.12);   color: #ff5252; }  .type-BOOM     .type-dot { background: #ff5252; }
    .type-BOUNDARY  { background: rgba(0,188,212,0.12);   color: #00bcd4; }  .type-BOUNDARY .type-dot { background: #00bcd4; }
    .type-GOOSENECK { background: rgba(255,152,0,0.12);   color: #ff9800; }  .type-GOOSENECK .type-dot { background: #ff9800; }
    .type-COMBO     { background: rgba(233,30,99,0.12);   color: #e91e63; }  .type-COMBO    .type-dot { background: #e91e63; }
    .type-empty     { background: var(--bg-raised);       color: var(--text-dim); }  .type-empty .type-dot { background: var(--text-dim); }
    .type-INSTRUMENT { background: rgba(0,230,118,0.12); color: #00e676; } .type-INSTRUMENT .type-dot { background: #00e676; }

    .a1-presenter-primary { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    .a1-row.row-micd .a1-presenter-primary { color: var(--accent-green); }
    .a1-unassigned { font-size: 12px; color: var(--text-dim); font-style: italic; }
    .a1-shared-tag {
        display: inline-block; margin-left: 8px; font-size: 9px;
        background: var(--bg-raised); color: var(--text-dim);
        border: 1px solid var(--border-bright); padding: 1px 7px;
        border-radius: 10px; vertical-align: middle;
    }

    .a1-micd-cell { width: 80px; text-align: center; }
    .a1-micd-toggle {
        display: inline-flex; align-items: center; justify-content: center;
        width: 58px; height: 28px; border-radius: 4px; font-size: 11px;
        font-weight: 800; letter-spacing: 0.1em; cursor: pointer; border: none;
        transition: all 0.15s; text-transform: uppercase; font-family: inherit;
    }
    .a1-micd-toggle.off { background: var(--bg-raised); color: var(--text-dim); border: 1px solid var(--border); }
    .a1-micd-toggle.on  { background: var(--accent-green); color: #000; box-shadow: 0 0 12px rgba(0,230,118,0.4); }

    .a1-notes-cell { width: 200px; }
    .a1-notes-input {
        width: 100%; background: transparent; border: none;
        border-bottom: 1px solid transparent; color: var(--text-secondary);
        font-size: 11px; font-family: inherit; padding: 2px 4px; outline: none;
        transition: border-color 0.15s;
    }
    .a1-notes-input:focus { border-bottom-color: var(--border-bright); }
    .a1-notes-input::placeholder { color: var(--text-dim); }

    .a1-actions-bar {
        display: flex; justify-content: flex-end; padding: 7px 12px;
        background: #13131f; border-bottom: 1px solid var(--border); gap: 6px;
    }

    /* A2 cards */
    .a2-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(460px, 1fr)); gap: 12px; padding: 14px; }

    .a2-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; overflow: visible; }
    .a2-card.card-micd { border-color: var(--micd-border); box-shadow: 0 0 0 1px rgba(0,230,118,0.1) inset; }

    .a2-presenter-details { flex: 1; min-width: 0; overflow: visible; }
    .a2-card.card-micd .a2-card-header { background: rgba(0,230,118,0.06); border-bottom-color: var(--micd-border); }

    .a2-rf-badge {
        width: 40px; height: 40px; border-radius: 5px; background: var(--bg-raised);
        border: 1px solid var(--border-bright); display: flex; align-items: center;
        justify-content: center; font-size: 17px; font-weight: 800; color: var(--text-primary); flex-shrink: 0;
    }
    .a2-card.card-micd .a2-rf-badge { background: rgba(0,230,118,0.15); border-color: var(--accent-green); color: var(--accent-green); }
    .a2-card-meta { flex: 1; }

    .a2-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: #14142a;
        border-bottom: 1px solid var(--border);
        justify-content: space-between;
    }

    .a2-micd-toggle {
        padding: 8px 16px; border-radius: 5px; font-size: 11px; font-weight: 800;
        letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; border: none;
        transition: all 0.15s; display: flex; align-items: center; gap: 7px; font-family: inherit;
    }
    .a2-micd-toggle.off { background: var(--bg-raised); color: var(--text-dim); border: 1px solid var(--border); }
    .a2-micd-toggle.on  { background: var(--accent-green); color: #000; box-shadow: 0 0 16px rgba(0,230,118,0.45); }
    .a2-micd-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .a2-micd-toggle.on .a2-micd-dot { animation: pulse-dot 1.4s ease-in-out infinite; }
    @keyframes pulse-dot { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.5);opacity:0.6} }

    .a2-presenter-block { display: flex; padding: 14px; border-bottom: 1px solid var(--border); }
    .a2-presenter-block:last-of-type { border-bottom: none; }
    .a2-presenter-block.shared-block { background: rgba(255,255,255,0.015); padding-left: 20px; }

    .a2-photo-zone {
        width: 70px; height: 70px; flex-shrink: 0; border-radius: 5px;
        border: 1px dashed var(--border-bright); background: var(--bg-raised);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        overflow: visible; cursor: pointer; margin-right: 14px; transition: border-color 0.15s;
        position: relative;
    }
    .a2-photo-zone:hover { border-color: var(--accent-blue); }
    .a2-photo-zone > img { width: 70px; height: 70px; object-fit: cover; border-radius: 5px; display: block; }
    .a2-photo-placeholder { display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .a2-photo-icon { font-size: 22px; opacity: 0.25; }
    .a2-photo-label { font-size: 8px; color: var(--text-dim); letter-spacing: 0.06em; text-transform: uppercase; text-align: center; }
    .a2-photo-input { display: none; }

    /* Photo hover expand */
    .a2-photo-expand {
        display: none; position: absolute; top: 0; left: 0; z-index: 200;
        width: 200px; height: 200px; border-radius: 8px; overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        border: 2px solid var(--accent-blue);
    }
    .a2-photo-expand img { width: 100%; height: 100%; object-fit: cover; }
    .a2-photo-zone:hover .a2-photo-expand { display: block; }

    .a2-presenter-details { flex: 1; min-width: 0; }
    .a2-presenter-name-row { display: flex; align-items: baseline; gap: 8px; margin-bottom: 10px; position: relative; }
    .a2-presenter-role { font-size: 9px; color: var(--text-secondary); letter-spacing: 0.1em; text-transform: uppercase; flex-shrink: 0; }

    .a2-presenter-name { font-size: 15px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .a2-unassigned { color: #6060a0; font-style: italic; font-size: 13px; }

    .a2-settings-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    .a2-setting { display: flex; flex-direction: column; gap: 3px; }
    .a2-setting-label { font-size: 8px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-secondary); }

    /* FIX: restored missing .a2-select base rule */
    .a2-select {
        background: var(--bg-input);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        font-size: 11px;
        border-radius: 3px;
        padding: 3px 6px;
        font-family: inherit;
        cursor: pointer;
    }
    .a2-select:focus { border-color: var(--accent-blue); color: var(--text-primary); }
    .a2-select option { background: #1e1e32; }

    .a2-notes-input { color: var(--text-primary); }
    .a2-notes-input:focus { border-color: var(--accent-blue); height: 52px; }
    .a2-notes-input::placeholder { color: #6060a0; }

    /* Slot queue */
    .a2-slot-queue { border-top: 1px solid var(--border); padding: 8px 14px 4px; background: #13131f; }
    .a2-slot-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .a2-slot-btn { background: rgba(74,158,255,0.15); border: 1px solid rgba(74,158,255,0.4); color: var(--accent-blue); font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 4px; cursor: pointer; letter-spacing: 0.05em; }
    .a2-slot-btn:hover { background: rgba(74,158,255,0.25); }
    .a2-slot-counter { font-size: 11px; font-weight: 700; color: var(--text-secondary); letter-spacing: 0.05em; }
    .a2-slot-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 6px; }
    .a2-slot-chip { font-size: 10px; padding: 3px 9px; border-radius: 10px; background: var(--bg-raised); color: var(--text-dim); border: 1px solid var(--border); display: inline-flex; align-items: center; }
    .a2-slot-chip.active { background: rgba(74,158,255,0.15); color: var(--accent-blue); border-color: rgba(74,158,255,0.4); font-weight: 600; }
    .a2-slot-remove { margin-left: 5px; opacity: 0.4; cursor: pointer; font-size: 9px; }
    .a2-slot-remove:hover { opacity: 1; color: #ff4444; }
    .a2-add-slot-bar { padding: 6px 14px 10px; background: #13131f; border-top: 1px solid var(--border); }
    .a2-add-slot-btn { background: none; border: 1px dashed var(--border-bright); color: var(--text-dim); font-size: 10px; padding: 4px 12px; border-radius: 4px; cursor: pointer; width: 100%; }
    .a2-add-slot-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

    /* Print */
    @media print {
        .mtt-header-actions, .session-tabs, .mtt-day-actions, .session-actions,
        .a1-actions-bar, .mtt-add-session-bar, .session-panel:not(.active),
        #mic-tracker-update-banner { display: none !important; }
        body, #mic-tracker-root { background: #fff; color: #000; }
        .a1-table thead th { background: #f0f0f0; color: #333; }
        .a1-row { border-bottom-color: #ddd; }
        .a1-micd-toggle.on { background: #000; color: #fff; box-shadow: none; }
        .mtt-day, .mtt-session { border-color: #ccc; }
        .mtt-day-header, .mtt-session-header { background: #f5f5f5; }
    }

    #mic-tracker-update-banner {
        display: none; position: fixed; top: 0; left: 0; right: 0;
        background: var(--accent-blue); color: #000; padding: 10px 16px;
        text-align: center; z-index: 99999; font-size: 13px; font-weight: 600;
    }

    .a2-presenter-input {
        background: transparent; border: none;
        border-bottom: 1px solid transparent;
        color: var(--text-primary); font-size: 15px;
        font-weight: 600; font-family: inherit;
        width: 100%; outline: none; padding: 2px 0;
        transition: border-color 0.15s;
    }
    .a2-presenter-input:focus { border-bottom-color: var(--border-bright); }
    .a2-presenter-input::placeholder { color: #6060a0; font-style: italic; font-weight: 400; font-size: 13px; }

    .presenter-dropdown {
        position: absolute;
        top: auto;
        bottom: auto;
        left: 0;
        background: var(--bg-raised);
        border: 1px solid var(--border-bright); border-radius: 4px;
        min-width: 220px; z-index: 1000;
        display: none;
        max-height: 160px;
        overflow-y: auto;
        padding-top: 4px;
    }
    .presenter-dropdown.open { display: block; }
    .presenter-dd-item {
        padding: 8px 12px; font-size: 12px; color: var(--text-secondary);
        cursor: pointer;
    }
    .presenter-dd-item:hover { background: var(--bg-input); color: var(--text-primary); }
    .presenter-dd-add { color: var(--accent-blue); border-top: 1px solid var(--border); }

    /* Mic Groups */
    .a1-row.group-blue   { border-left: 4px solid #4a9eff; }
    .a1-row.group-amber  { border-left: 4px solid #ffab00; }
    .a1-row.group-red    { border-left: 4px solid #ff5252; }
    .a1-row.group-purple { border-left: 4px solid #b464ff; }
    .a1-row.group-teal   { border-left: 4px solid #00bcd4; }

    .group-dot {
        width: 14px; height: 14px; border-radius: 50%;
        display: inline-block; cursor: pointer; flex-shrink: 0;
        border: 2px solid transparent; transition: transform 0.1s;
    }
    .group-dot:hover { transform: scale(1.2); }
    .group-dot.empty { background: var(--border-bright); border: 2px dashed var(--text-dim); }
    .group-dot.color-blue   { background: #4a9eff; }
    .group-dot.color-amber  { background: #ffab00; }
    .group-dot.color-red    { background: #ff5252; }
    .group-dot.color-purple { background: #b464ff; }
    .group-dot.color-teal   { background: #00bcd4; }

    .group-picker {
        position: absolute; z-index: 500; background: var(--bg-raised);
        border: 1px solid var(--border-bright); border-radius: 6px;
        padding: 10px; min-width: 180px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4); display: none;
    }
    .group-picker.open { display: block; }
    .group-picker-title { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; }
    .group-picker-item {
        display: flex; align-items: center; gap: 8px;
        padding: 5px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;
        color: var(--text-secondary);
    }
    .group-picker-item:hover { background: var(--bg-input); color: var(--text-primary); }
    .group-picker-item.selected { color: var(--text-primary); font-weight: 600; }
    .group-picker-none { color: var(--text-dim); font-size: 11px; padding: 5px 6px; cursor: pointer; }
    .group-picker-none:hover { color: var(--text-secondary); }
    .group-picker-divider { height: 1px; background: var(--border); margin: 6px 0; }
    .group-picker-manage { font-size: 10px; color: var(--accent-blue); padding: 4px 6px; cursor: pointer; }
    .group-picker-manage:hover { text-decoration: underline; }

    .group-manage-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    }
    .group-manage-modal.hidden { display: none; }
    .group-manage-box {
        background: var(--bg-raised); border: 1px solid var(--border-bright);
        border-radius: 8px; padding: 24px; min-width: 320px; max-width: 400px;
    }
    .group-manage-title { font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; }
    .group-manage-list { margin-bottom: 12px; }
    .group-manage-item {
        display: flex; align-items: center; gap: 10px;
        padding: 7px 0; border-bottom: 1px solid var(--border);
    }
    .group-manage-item:last-child { border-bottom: none; }
    .group-manage-name { flex: 1; font-size: 13px; color: var(--text-primary); }
    .group-manage-delete { background: none; border: none; color: var(--accent-red); cursor: pointer; font-size: 14px; padding: 2px 6px; }
    .group-add-row { display: flex; gap: 8px; margin-top: 12px; }
    .group-add-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border-bright); color: var(--text-primary); border-radius: 4px; padding: 6px 10px; font-size: 12px; }
    .group-color-select { background: var(--bg-input); border: 1px solid var(--border-bright); color: var(--text-primary); border-radius: 4px; padding: 6px 8px; font-size: 12px; }
    .group-add-btn { background: var(--accent-blue); color: #000; border: none; border-radius: 4px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; }
    .group-modal-close { float: right; background: none; border: none; color: var(--text-dim); font-size: 18px; cursor: pointer; margin-top: -4px; }

    .a1-group-cell { width: 28px; text-align: center; padding: 0 4px !important; position: relative; }

    </style>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script src="{% static 'admin/js/jquery.init.js' %}"></script>
{% endblock %}

{% block content %}
<div id="mic-tracker-root">

    <div id="mic-tracker-update-banner">
        ðŸ”„ <strong>Updates Available</strong> â€” another user made changes.
        <button onclick="location.reload()" style="margin-left:12px;background:#000;color:#4a9eff;border:none;padding:6px 16px;border-radius:4px;cursor:pointer;font-weight:700;">Refresh</button>
        <button onclick="document.getElementById('mic-tracker-update-banner').style.display='none'" style="margin-left:6px;background:transparent;border:1px solid #000;color:#000;padding:6px 12px;border-radius:4px;cursor:pointer;">Dismiss</button>
    </div>

    <!-- Page Header -->
    <div class="mtt-header">
        <div class="mtt-title">ðŸŽ¤ Mic Tracker</div>
        <div class="mtt-show-meta">
            <div class="mtt-meta-item">
                <span class="mtt-meta-label">Show</span>
                <span class="mtt-meta-value">{{ show_info.show_name|default:"â€”" }}</span>
            </div>
            <div class="mtt-meta-item">
                <span class="mtt-meta-label">Venue</span>
                <span class="mtt-meta-value">{{ show_info.venue_name|default:"â€”" }}</span>
            </div>
            <div class="mtt-meta-item">
                <span class="mtt-meta-label">Room</span>
                <span class="mtt-meta-value">{{ show_info.ballroom_name|default:"â€”" }}</span>
            </div>
            <div class="mtt-meta-item">
                <span class="mtt-meta-label">Dates</span>
                <span class="mtt-meta-value">{{ show_info.duration_display|default:"â€”" }}</span>
            </div>
        </div>
        <div class="mtt-header-actions">
            {% if not is_viewer %}
            <button class="btn-mtt btn-mtt-primary" onclick="addNewDay()">+ Add Day</button>
            {% endif %}
            <a href="/audiopatch/mic-tracker/export/" class="btn-mtt btn-mtt-export">â†“ Export CSV</a>
        </div>
    </div>

    <!-- Days -->
    {% for day_data in days_data %}
    <div class="mtt-day" data-day-id="{{ day_data.day.id }}">
        <div class="mtt-day-header" onclick="toggleDay({{ day_data.day.id }}, this)">
            <span class="mtt-day-collapse {% if day_data.day.is_collapsed %}collapsed{% endif %}">â–¼</span>
            <span class="mtt-day-name">{{ day_data.day }}</span>
            <div class="mtt-day-stats">
                {% with stats=day_data.day.get_all_mics_status %}
                <span><strong>{{ stats.used }}</strong>/{{ stats.total }} mic'd</span>
                <span>{{ day_data.day.sessions.count }} session{{ day_data.day.sessions.count|pluralize }}</span>
                {% endwith %}
            </div>
            <div class="mtt-day-actions">
            </div>
        </div>

        <div class="mtt-day-content" {% if day_data.day.is_collapsed %}style="display:none"{% endif %}>

            {% for session in day_data.sessions %}
            <div class="mtt-session" data-session-id="{{ session.id }}">

                <!-- Session header with collapse toggle and A1/A2 tabs -->
                <div class="mtt-session-header" onclick="toggleSession({{ session.id }}, event)">
                    <span class="mtt-session-collapse" id="session-collapse-{{ session.id }}">â–¼</span>
                    <div class="session-tabs">
                        <button class="session-tab active" onclick="switchSessionTab({{ session.id }}, 'a1', this)">A1</button>
                        <button class="session-tab" onclick="switchSessionTab({{ session.id }}, 'a2', this)">A2</button>
                    </div>
                    <span class="mtt-session-date">{{ session.day.date|date:"m/d" }}</span>
                    <span class="mtt-session-name">{{ session.name }}</span>
                    {% if session.location %}<span class="mtt-session-loc">Â· {{ session.location }}</span>{% endif %}

                    {% if not is_viewer %}
                    <div class="session-actions">
                        <button class="btn-icon-sm" title="Duplicate" onclick="duplicateSession({{ session.id }})">ðŸ“‹</button>
                        <button class="btn-icon-sm" title="Settings" onclick="editSession({{ session.id }})">âš™</button>
                    </div>
                    {% endif %}
                </div>

                <!-- Session body (collapsible) -->
                <div class="mtt-session-body" id="session-body-{{ session.id }}">

                    <!-- A1 Panel -->
                    <div class="session-panel active" id="session-{{ session.id }}-a1">
                        <div class="a1-actions-bar">
                            <button class="btn-mtt btn-mtt-ghost" style="font-size:10px;padding:5px 10px;" onclick="window.print()">ðŸ–¨ Print</button>
                        </div>
                        <table class="a1-table">
                            <thead>
                                <tr>
                                    <th style="width:44px;padding:4px 0;text-align:center;">
                                    {% if not is_viewer %}
                                    <button onclick="openGroupManager({{ session.id }})"
                                            style="font-size:10px;font-weight:800;letter-spacing:0.08em;padding:5px 8px;
                                                background:rgba(74,158,255,0.15);border:1px solid var(--accent-blue);
                                                color:var(--accent-blue);border-radius:3px;cursor:pointer;
                                                line-height:1;">GRP</button>
                                    {% endif %}
                                    </th>
                                    <th style="width:56px;">RF#</th>
                                    <th style="width:110px;">Type</th>
                                    <th>Presenter</th>
                                    <th class="th-center a1-micd-cell">MIC'D</th>
                                    <th class="a1-notes-cell">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for assignment in session.mic_assignments.all %}
                            <tr class="a1-row {% if assignment.is_micd %}row-micd{% endif %} {% if assignment.group %}group-{{ assignment.group.color }}{% endif %}"
                                id="a1-row-{{ assignment.id }}" data-assignment-id="{{ assignment.id }}">
                                <td class="a1-group-cell">
                                    {% if not is_viewer %}
                                    <span class="group-dot {% if assignment.group %}color-{{ assignment.group.color }}{% else %}empty{% endif %}"
                                          onclick="openGroupPicker({{ assignment.id }}, {{ session.id }}, this)"
                                          title="{% if assignment.group %}{{ assignment.group.name }}{% else %}Assign group{% endif %}">
                                    </span>
                                    <div class="group-picker" id="group-picker-{{ assignment.id }}"></div>
                                    {% endif %}
                                </td>
                                <td class="a1-rf">{{ assignment.rf_number|stringformat:"02d" }}</td>
                                <td>
                                    {% if assignment.mic_type %}
                                    <span class="mic-type-badge type-{{ assignment.mic_type }}"><span class="type-dot"></span>{{ assignment.mic_type }}</span>
                                    {% else %}
                                    <span class="mic-type-badge type-empty"><span class="type-dot"></span>â€”</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if assignment.presenter %}
                                    <span class="a1-presenter-primary">{{ assignment.presenter.name }}</span>
                                    {% if assignment.presenter_slots.count > 1 %}<span class="a1-shared-tag">+{{ assignment.presenter_slots.count|add:"-1" }} more</span>{% endif %}
                                    {% else %}
                                    <span class="a1-unassigned">â€” Unassigned â€”</span>
                                    {% endif %}
                                </td>
                                <td class="a1-micd-cell">
                                    <button class="a1-micd-toggle {% if assignment.is_micd %}on{% else %}off{% endif %}"
                                            onclick="toggleMicd({{ assignment.id }}, this)"
                                            {% if is_viewer %}disabled style="cursor:default"{% endif %}>
                                        {% if assignment.is_micd %}ON{% else %}â€”{% endif %}
                                    </button>
                                </td>
                                <td class="a1-notes-cell">
                                    <input type="text" class="a1-notes-input"
                                           value="{{ assignment.notes|default:'' }}"
                                           placeholder="notes..."
                                           onchange="updateField({{ assignment.id }}, 'notes', this.value)"
                                           {% if is_viewer %}readonly{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- A2 Panel -->
                    <div class="session-panel" id="session-{{ session.id }}-a2">
                        <div class="a2-grid">
                        {% for assignment in session.mic_assignments.all %}
                        <div class="a2-card {% if assignment.is_micd %}card-micd{% endif %}"
                             id="a2-card-{{ assignment.id }}" data-assignment-id="{{ assignment.id }}">

                            <div class="a2-card-header">
                                <div class="a2-rf-badge">{{ assignment.rf_number|stringformat:"02d" }}</div>
                                <div class="a2-card-meta">
                                    {% if assignment.mic_type %}
                                    <span class="mic-type-badge type-{{ assignment.mic_type }}" style="font-size:9px;padding:2px 7px;">
                                        <span class="type-dot"></span>{{ assignment.mic_type }}
                                    </span>
                                    {% endif %}
                                </div>
                                <button class="a2-micd-toggle {% if assignment.is_micd %}on{% else %}off{% endif %}"
                                        onclick="toggleMicdA2({{ assignment.id }}, this)"
                                        {% if is_viewer %}disabled style="cursor:default"{% endif %}>
                                    <span class="a2-micd-dot"></span>MIC'D
                                </button>
                            </div>

                            <!-- FIX: photo zone now keyed to active_slot.id for discrete per-presenter photos -->
                            {% with active_slot=assignment.active_slot %}
                            <div class="a2-presenter-block">
                                <div class="a2-photo-zone"
                                     id="photo-zone-{{ assignment.id }}"
                                     onclick="{% if not is_viewer %}triggerPhotoForSlot({% if active_slot %}{{ active_slot.id }}{% else %}0{% endif %}, {{ assignment.id }}){% endif %}">
                                    {% if active_slot and active_slot.photo %}
                                    <img src="{{ active_slot.photo.url }}"
                                         alt="{{ active_slot.presenter.name|default:'' }}"
                                         id="photo-img-{{ assignment.id }}">
                                    <div class="a2-photo-expand">
                                        <img src="{{ active_slot.photo.url }}" id="photo-expand-{{ assignment.id }}">
                                    </div>
                                    {% else %}
                                    <div class="a2-photo-placeholder" id="photo-placeholder-{{ assignment.id }}">
                                        <span class="a2-photo-icon">ðŸ‘¤</span>
                                        {% if not is_viewer %}<span class="a2-photo-label">Photo</span>{% endif %}
                                    </div>
                                    {% endif %}
                                    {% if not is_viewer %}
                                    <input type="file" class="a2-photo-input"
                                           id="photo-input-slot-{% if active_slot %}{{ active_slot.id }}{% else %}0{% endif %}"
                                           data-assignment-id="{{ assignment.id }}"
                                           accept="image/*"
                                           onchange="uploadPhotoForSlot({% if active_slot %}{{ active_slot.id }}{% else %}0{% endif %}, {{ assignment.id }}, this)">
                                    {% endif %}
                                </div>
                                {% endwith %}

                                <div class="a2-presenter-details">
                                    <div class="a2-presenter-name-row">
                                        <span class="a2-presenter-role">Primary</span>
                                        <input type="text"
                                                class="a2-presenter-input"
                                                id="presenter-input-{{ assignment.id }}"
                                                value="{% if assignment.presenter %}{{ assignment.presenter.name }}{% endif %}"
                                                placeholder="â€” Unassigned â€”"
                                                autocomplete="off"
                                                onfocus="searchPresenters({{ assignment.id }}, '')"
                                                oninput="searchPresenters({{ assignment.id }}, this.value)"
                                                onchange="assignPresenter({{ assignment.id }}, this.value)"
                                                onblur="assignPresenter({{ assignment.id }}, this.value)"
                                                {% if is_viewer %}readonly{% endif %}>
                                        <div class="presenter-dropdown" id="presenter-dd-{{ assignment.id }}"></div>
                                    </div>
                                    <div class="a2-settings-row">
                                        <div class="a2-setting">
                                            <span class="a2-setting-label">Type</span>
                                            <select class="a2-select" onchange="updateMicType({{ assignment.id }}, this.value)" {% if is_viewer %}disabled{% endif %}>
                                                <option value="">â€” select â€”</option>
                                                <option value="HH"        {% if assignment.mic_type == 'HH'        %}selected{% endif %}>Handheld</option>
                                                <option value="LAV"       {% if assignment.mic_type == 'LAV'       %}selected{% endif %}>Lav</option>
                                                <option value="HEADSET"   {% if assignment.mic_type == 'HEADSET'   %}selected{% endif %}>Headset</option>
                                                <option value="PODIUM"    {% if assignment.mic_type == 'PODIUM'    %}selected{% endif %}>Podium</option>
                                                <option value="BOOM"      {% if assignment.mic_type == 'BOOM'      %}selected{% endif %}>Boom</option>
                                                <option value="INSTRUMENT"{% if assignment.mic_type == 'INSTRUMENT'%}selected{% endif %}>Instrument</option>
                                            </select>
                                        </div>
                                        <div class="a2-setting">
                                            <span class="a2-setting-label">Placement</span>
                                            <select class="a2-select" onchange="updateField({{ assignment.id }}, 'placement', this.value)" {% if is_viewer %}disabled{% endif %}>
                                                <option value="">â€” select â€”</option>
                                                <option value="LEFT_EAR"     {% if assignment.placement == 'LEFT_EAR'     %}selected{% endif %}>Left Ear</option>
                                                <option value="RIGHT_EAR"    {% if assignment.placement == 'RIGHT_EAR'    %}selected{% endif %}>Right Ear</option>
                                                <option value="TIE"          {% if assignment.placement == 'TIE'          %}selected{% endif %}>Tie</option>
                                                <option value="LAV_MAGNET"   {% if assignment.placement == 'LAV_MAGNET'   %}selected{% endif %}>Lav Magnet</option>
                                                <option value="COLLAR"       {% if assignment.placement == 'COLLAR'       %}selected{% endif %}>Collar</option>
                                                <option value="HAIR_MOUNT"   {% if assignment.placement == 'HAIR_MOUNT'   %}selected{% endif %}>Hair Mount</option>
                                                <option value="CHEEK"        {% if assignment.placement == 'CHEEK'        %}selected{% endif %}>Cheek Mount</option>
                                                <option value="FOREHEAD"     {% if assignment.placement == 'FOREHEAD'     %}selected{% endif %}>Forehead</option>
                                                <option value="CHEST_POCKET" {% if assignment.placement == 'CHEST_POCKET' %}selected{% endif %}>Chest Pocket</option>
                                                <option value="BELT_CLIP"    {% if assignment.placement == 'BELT_CLIP'    %}selected{% endif %}>Belt Clip</option>
                                            </select>
                                        </div>
                                        <div class="a2-setting">
                                            <span class="a2-setting-label">Sensitivity</span>
                                            <select class="a2-select" onchange="updateField({{ assignment.id }}, 'sensitivity', this.value)" {% if is_viewer %}disabled{% endif %}>
                                                <option value="">â€” select â€”</option>
                                                {% for val, label in assignment.SENSITIVITY_CHOICES %}{% if val %}<option value="{{ val }}" {% if assignment.sensitivity == val %}selected{% endif %}>{{ label }}</option>{% endif %}{% endfor %}
                                            </select>
                                        </div>
                                        <div class="a2-setting">
                                            <span class="a2-setting-label">Output Level</span>
                                            <select class="a2-select" onchange="updateField({{ assignment.id }}, 'output_level', this.value)" {% if is_viewer %}disabled{% endif %}>
                                                <option value="">â€” select â€”</option>
                                                {% for val, label in assignment.OUTPUT_LEVEL_CHOICES %}{% if val %}<option value="{{ val }}" {% if assignment.output_level == val %}selected{% endif %}>{{ label }}</option>{% endif %}{% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <textarea class="a2-notes-input"
                                              placeholder="Notes (allergies, preferences, setup tips...)"
                                              onchange="updateField({{ assignment.id }}, 'notes', this.value)"
                                              {% if is_viewer %}readonly{% endif %}>{{ assignment.notes|default:'' }}</textarea>
                                </div>
                            </div>

                            {% with slots=assignment.presenter_slots.all slot_count=assignment.presenter_slots.count %}
                            {% if slot_count > 1 %}
                            <div class="a2-slot-queue" id="slot-queue-{{ assignment.id }}">
                                <div class="a2-slot-nav">
                                    {% if not is_viewer %}
                                    <button class="a2-slot-btn" onclick="prevSlot({{ assignment.id }})">â—€ PREV</button>
                                    {% endif %}
                                    <span class="a2-slot-counter" id="slot-counter-{{ assignment.id }}">
                                        {% for slot in slots %}{% if slot.is_active %}{{ forloop.counter }}{% endif %}{% endfor %} / {{ slot_count }}
                                    </span>
                                    {% if not is_viewer %}
                                    <button class="a2-slot-btn a2-slot-btn-next" onclick="nextSlot({{ assignment.id }})">NEXT â–¶</button>
                                    {% endif %}
                                </div>
                                <div class="a2-slot-list">
                                    {% for slot in slots %}
                                    <div class="a2-slot-chip {% if slot.is_active %}active{% endif %}" data-slot-id="{{ slot.id }}">
                                        {{ slot.presenter.name|default:"Unassigned" }}
                                        {% if not is_viewer %}
                                        <span class="a2-slot-remove" onclick="event.stopPropagation(); removePresenterSlot({{ assignment.id }}, {{ slot.id }})">âœ•</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            {% if not is_viewer %}
                            <div class="a2-add-slot-bar">
                                <button class="a2-add-slot-btn" onclick="addPresenterSlot({{ assignment.id }})">+ Add Presenter</button>
                            </div>
                            {% endif %}
                            {% endwith %}

                        </div>
                        {% endfor %}
                        </div>
                    </div>

                    <!-- Session stats footer -->
                    <div class="mtt-session-stats">
                        {% with stats=session.get_mic_usage_stats %}
                        <span>MIC'D: <strong>{{ stats.micd }}</strong>/{{ stats.total }}</span>
                        <span>D-MIC: {{ stats.d_mic }}</span>
                        {% if stats.shared > 0 %}<span>Shared: {{ stats.shared }}</span>{% endif %}
                        {% endwith %}
                    </div>

                </div><!-- end mtt-session-body -->
            </div><!-- end mtt-session -->
            {% endfor %}

            <!-- Add Session button at bottom of day -->
            {% if not is_viewer %}
            <div class="mtt-add-session-bar">
                <button class="btn-mtt btn-mtt-ghost" style="font-size:10px;padding:5px 10px;"
                    onclick="event.stopPropagation(); openGroupManager({{ session.id }})">â¬¤ Groups</button>
            </div>
            {% endif %}

        </div><!-- end mtt-day-content -->
    </div><!-- end mtt-day -->
    {% empty %}
    <div style="padding:48px;text-align:center;color:var(--text-dim);">
        No show days yet.
        {% if not is_viewer %}
        <button class="btn-mtt btn-mtt-primary" onclick="addNewDay()" style="margin-left:12px;">+ Add Day</button>
        {% endif %}
    </div>
    {% endfor %}

</div>

<!-- Group Manager Modal -->
<div class="group-manage-modal hidden" id="group-manage-modal">
    <div class="group-manage-box">
        <button class="group-modal-close" onclick="closeGroupManager()">Ã—</button>
        <div class="group-manage-title">Manage Groups</div>
        <div class="group-manage-list" id="group-manage-list"></div>
        <div class="group-add-row">
            <input type="text" class="group-add-input" id="group-add-name" placeholder="Group name (e.g. CEO Panel)">
            <select class="group-color-select" id="group-add-color">
                <option value="blue">ðŸ”µ Blue</option>
                <option value="amber">ðŸŸ¡ Amber</option>
                <option value="red">ðŸ”´ Red</option>
                <option value="purple">ðŸŸ£ Purple</option>
                <option value="teal">ðŸ©µ Teal</option>
            </select>
            <button class="group-add-btn" onclick="addGroup()">Add</button>
        </div>
    </div>
</div>

<datalist id="presenters-datalist"></datalist>
<script src="{% static 'admin/js/mic_tracker.js' %}"></script>

<script>
// â”€â”€ Session tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchSessionTab(sessionId, tabId, btn) {
    const session = document.querySelector('[data-session-id="' + sessionId + '"]');
    if (!session) return;
    session.querySelectorAll('.session-panel').forEach(p => p.classList.remove('active'));
    session.querySelectorAll('.session-tab').forEach(t => t.classList.remove('active'));
    const panel = document.getElementById('session-' + sessionId + '-' + tabId);
    if (panel) panel.classList.add('active');
    btn.classList.add('active');
    localStorage.setItem('sessionTab-' + sessionId, tabId);
}

// â”€â”€ Dropdown close on outside click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('mousedown', function(e) {
    if (!e.target.closest('.presenter-dropdown') &&
        !e.target.classList.contains('a2-presenter-input')) {
        document.querySelectorAll('.presenter-dropdown').forEach(d => d.classList.remove('open'));
    }
});

// â”€â”€ Session collapse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSession(sessionId, event) {
    if (event.target.closest('.session-tabs') ||
        event.target.closest('.session-actions') ||
        event.target.closest('.mtt-dropdown-menu')) return;

    const body = document.getElementById('session-body-' + sessionId);
    const icon = document.getElementById('session-collapse-' + sessionId);
    if (!body) return;
    const isCollapsed = body.classList.contains('collapsed');
    body.classList.toggle('collapsed', !isCollapsed);
    if (icon) icon.classList.toggle('collapsed', !isCollapsed);
}

// â”€â”€ Day collapse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDay(dayId, headerEl) {
    const dayEl = headerEl.closest('.mtt-day');
    const content = dayEl.querySelector('.mtt-day-content');
    const icon = dayEl.querySelector('.mtt-day-collapse');
    if (!content) return;
    const isCollapsed = content.style.display === 'none';
    content.style.display = isCollapsed ? '' : 'none';
    if (icon) icon.classList.toggle('collapsed', !isCollapsed);
    fetch('/audiopatch/api/toggle-day-collapse/', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCsrfToken()},
        body: 'day_id=' + dayId
    });
}

// â”€â”€ MIC'D toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMicd(assignmentId, btn) {
    const isOn = btn.classList.contains('on');
    const newState = !isOn;
    btn.classList.toggle('on', newState);
    btn.classList.toggle('off', !newState);
    btn.textContent = newState ? 'ON' : 'â€”';
    const row = document.getElementById('a1-row-' + assignmentId);
    if (row) row.classList.toggle('row-micd', newState);
    const card = document.getElementById('a2-card-' + assignmentId);
    if (card) {
        card.classList.toggle('card-micd', newState);
        const a2btn = card.querySelector('.a2-micd-toggle');
        if (a2btn) { a2btn.classList.toggle('on', newState); a2btn.classList.toggle('off', !newState); }
    }
    updateField(assignmentId, 'is_micd', newState);
}

function updateMicType(assignmentId, value) {
    updateField(assignmentId, 'mic_type', value);
    const card = document.getElementById('a2-card-' + assignmentId);
    if (!card) return;
    const meta = card.querySelector('.a2-card-meta');
    if (!meta) return;
    const labels = {
        'HH': 'HH', 'LAV': 'LAV', 'HEADSET': 'HEADSET',
        'PODIUM': 'PODIUM', 'BOOM': 'BOOM', 'INSTRUMENT': 'INSTRUMENT'
    };
    if (value && labels[value]) {
        meta.innerHTML = '<span class="mic-type-badge type-' + value + '" style="font-size:9px;padding:2px 7px;">' +
            '<span class="type-dot"></span>' + labels[value] + '</span>';
    } else {
        meta.innerHTML = '';
    }
    const a1td = document.querySelector('#a1-row-' + assignmentId + ' .mic-type-badge');
    if (a1td) {
        a1td.className = 'mic-type-badge type-' + (value || 'empty');
        a1td.innerHTML = '<span class="type-dot"></span>' + (labels[value] || 'â€”');
    }
}

function toggleMicdA2(assignmentId, btn) {
    const isOn = btn.classList.contains('on');
    const newState = !isOn;
    btn.classList.toggle('on', newState);
    btn.classList.toggle('off', !newState);
    const card = document.getElementById('a2-card-' + assignmentId);
    if (card) card.classList.toggle('card-micd', newState);
    const a1btn = document.querySelector('#a1-row-' + assignmentId + ' .a1-micd-toggle');
    if (a1btn) {
        a1btn.classList.toggle('on', newState);
        a1btn.classList.toggle('off', !newState);
        a1btn.textContent = newState ? 'ON' : 'â€”';
        const row = document.getElementById('a1-row-' + assignmentId);
        if (row) row.classList.toggle('row-micd', newState);
    }
    updateField(assignmentId, 'is_micd', newState);
}

// â”€â”€ Photo uploads â€” FIX: keyed to slot.id not assignment.id â”€â”€â”€
function triggerPhotoForSlot(slotId, assignmentId) {
    if (!slotId) return;
    const input = document.getElementById('photo-input-slot-' + slotId);
    if (input) input.click();
}

async function uploadPhotoForSlot(slotId, assignmentId, input) {
    if (!slotId || !input.files[0]) return;
    const fd = new FormData();
    fd.append('slot_id', slotId);
    fd.append('photo', input.files[0]);
    const resp = await fetch('/audiopatch/api/mic/slot/upload-photo/', {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        body: fd
    });
    const data = await resp.json();
    if (data.success && data.photo_url) {
        const zone = document.getElementById('photo-zone-' + assignmentId);
        if (!zone) return;

        // Remove placeholder if present
        const placeholder = document.getElementById('photo-placeholder-' + assignmentId);
        if (placeholder) placeholder.style.display = 'none';

        // Update or create the thumbnail image
        let img = document.getElementById('photo-img-' + assignmentId);
        if (!img) {
            img = document.createElement('img');
            img.id = 'photo-img-' + assignmentId;
            img.style.cssText = 'width:70px;height:70px;object-fit:cover;border-radius:5px;display:block;';
            zone.insertBefore(img, zone.firstChild);
        }
        img.src = data.photo_url;

        // Update or create the hover-expand panel
        let expandDiv = document.getElementById('photo-expand-' + assignmentId);
        if (!expandDiv) {
            const wrapper = document.createElement('div');
            wrapper.className = 'a2-photo-expand';
            const expandImg = document.createElement('img');
            expandImg.id = 'photo-expand-' + assignmentId;
            wrapper.appendChild(expandImg);
            zone.appendChild(wrapper);
            expandDiv = expandImg;
        }
        expandDiv.src = data.photo_url;

        // Re-wire the file input for next upload
        const fileInput = zone.querySelector('.a2-photo-input');
        if (fileInput) {
            fileInput.setAttribute('onchange', 'uploadPhotoForSlot(' + slotId + ', ' + assignmentId + ', this)');
        }
    } else {
        alert('Photo upload failed: ' + (data.error || 'Unknown error'));
    }
}

// â”€â”€ Shared placement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSharedPlacement(assignmentId, presenterId, value) {
    fetch('/audiopatch/api/mic/update-shared-placement/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
        body: JSON.stringify({assignment_id: assignmentId, presenter_id: presenterId, placement: value})
    });
}

// â”€â”€ CSRF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCsrfToken() {
    const c = document.cookie.split(';').find(x => x.trim().startsWith('csrftoken='));
    return c ? c.trim().split('=')[1] : '';
}

// â”€â”€ Live update checker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
    let lastChecksum = null, lastActivity = Date.now(), hasUnseen = false;
    document.addEventListener('click', () => lastActivity = Date.now());
    document.addEventListener('keypress', () => lastActivity = Date.now());
    async function check() {
        try {
            const r = await fetch('/api/mic-tracker-checksum/');
            if (!r.ok) return;
            const data = await r.json();
            if (!data.checksum) return;
            if (lastChecksum === null) { lastChecksum = data.checksum; return; }
            if (data.checksum !== lastChecksum) {
                lastChecksum = data.checksum;
                if ((Date.now() - lastActivity) > 30000 && !hasUnseen) { location.reload(); }
                else { document.getElementById('mic-tracker-update-banner').style.display = 'block'; hasUnseen = true; }
            }
        } catch(e) {}
    }
    setInterval(check, 5000);
    setTimeout(check, 5000);
})();

// â”€â”€ Presenter search dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX: exactMatch / create-new block moved inside the .then() callback
function searchPresenters(assignmentId, query) {
    const dd = document.getElementById('presenter-dd-' + assignmentId);
    fetch('/audiopatch/api/presenters/list/?q=' + encodeURIComponent(query))
        .then(r => r.json())
        .then(data => {
            dd.innerHTML = '';
            if (!data.presenters || !data.presenters.length) { dd.classList.remove('open'); return; }

            data.presenters.forEach(p => {
                const item = document.createElement('div');
                item.className = 'presenter-dd-item';
                item.textContent = p.name;
                item.onmousedown = (e) => {
                    e.preventDefault();
                    document.getElementById('presenter-input-' + assignmentId).value = p.name;
                    dd.classList.remove('open');
                    updateField(assignmentId, 'presenter_id', p.id);
                    const a1primary = document.querySelector('#a1-row-' + assignmentId + ' .a1-presenter-primary');
                    if (a1primary) {
                        a1primary.textContent = p.name;
                    } else {
                        const a1unassigned = document.querySelector('#a1-row-' + assignmentId + ' .a1-unassigned');
                        if (a1unassigned) {
                            a1unassigned.outerHTML = '<span class="a1-presenter-primary">' + p.name + '</span>';
                        }
                    }
                };
                dd.appendChild(item);
            });

            // Determine if dropdown should open up or down
            const inputEl = document.getElementById('presenter-input-' + assignmentId);
            const inputRect = inputEl.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - inputRect.bottom;
            const spaceAbove = inputRect.top;

            if (spaceAbove > spaceBelow && spaceAbove > 160) {
                dd.style.bottom = '100%';
                dd.style.top = 'auto';
                dd.style.marginBottom = '4px';
                dd.style.marginTop = '0';
                dd.style.boxShadow = '0 -8px 24px rgba(0,0,0,0.4)';
            } else {
                dd.style.bottom = 'auto';
                dd.style.top = '100%';
                dd.style.marginBottom = '0';
                dd.style.marginTop = '4px';
                dd.style.boxShadow = '0 8px 24px rgba(0,0,0,0.4)';
            }

            dd.classList.add('open');

            // FIX: create-new option now correctly inside .then() scope
            const exactMatch = data.presenters.some(p => p.name.toLowerCase() === query.toLowerCase());
            if (query && !exactMatch) {
                const addItem = document.createElement('div');
                addItem.className = 'presenter-dd-item presenter-dd-add';
                addItem.textContent = '+ Add "' + query + '" as new presenter';
                addItem.onclick = () => {
                    fetch('/audiopatch/api/presenters/create/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken()},
                        body: JSON.stringify({name: query})
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('presenter-input-' + assignmentId).value = query;
                            dd.classList.remove('open');
                            updateField(assignmentId, 'presenter_id', data.presenter_id);
                            const a1primary = document.querySelector('#a1-row-' + assignmentId + ' .a1-presenter-primary');
                            if (a1primary) { a1primary.textContent = query; }
                            else {
                                const a1unassigned = document.querySelector('#a1-row-' + assignmentId + ' .a1-unassigned');
                                if (a1unassigned) a1unassigned.outerHTML = '<span class="a1-presenter-primary">' + query + '</span>';
                            }
                        }
                    });
                };
                dd.appendChild(addItem);
            }
        });
}

// FIX: use presenter_id (not presenter_name) for ForeignKey assignment
function assignPresenter(assignmentId, value) {
    const dd = document.getElementById('presenter-dd-' + assignmentId);
    dd.classList.remove('open');
    if (!value) {
        updateField(assignmentId, 'presenter_id', '');
    } else {
        updateField(assignmentId, 'presenter_id', value);
    }
}

async function nextSlot(assignmentId) {
    const resp = await fetch('/audiopatch/api/mic/slot/next/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({assignment_id: assignmentId})
    });
    const data = await resp.json();
    if (data.success) applySlotData(assignmentId, data);
}

async function prevSlot(assignmentId) {
    const resp = await fetch('/audiopatch/api/mic/slot/prev/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({assignment_id: assignmentId})
    });
    const data = await resp.json();
    if (data.success) applySlotData(assignmentId, data);
}

async function addPresenterSlot(assignmentId) {
    const resp = await fetch('/audiopatch/api/mic/slot/add/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({assignment_id: assignmentId})
    });
    const data = await resp.json();
    if (data.success) location.reload();
}

async function removePresenterSlot(assignmentId, slotId) {
    const resp = await fetch('/audiopatch/api/mic/slot/remove/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({assignment_id: assignmentId, slot_id: slotId})
    });
    const data = await resp.json();
    if (data.success) location.reload();
    else alert(data.error);
}

// FIX: applySlotData now updates the photo zone when navigating PREV/NEXT
function applySlotData(assignmentId, data) {
    const nameInput = document.getElementById('presenter-input-' + assignmentId);
    if (nameInput) nameInput.value = data.presenter_name || '';

    const card = document.getElementById('a2-card-' + assignmentId);
    if (card) {
        card.querySelectorAll('.a2-select').forEach(sel => {
            const oc = sel.getAttribute('onchange') || '';
            if (oc.includes('updateMicType')) sel.value = data.mic_type || '';
            else if (oc.includes("'placement'")) sel.value = data.placement || '';
            else if (oc.includes("'sensitivity'")) sel.value = data.sensitivity || '';
            else if (oc.includes("'output_level'")) sel.value = data.output_level || '';
        });
        const notes = card.querySelector('.a2-notes-input');
        if (notes) notes.value = data.notes || '';
    }

    const counter = document.getElementById('slot-counter-' + assignmentId);
    if (counter) counter.textContent = (data.slot_index + 1) + ' / ' + data.slot_count;

    document.querySelectorAll(`#slot-queue-${assignmentId} .a2-slot-chip`).forEach((chip, i) => {
        chip.classList.toggle('active', i === data.slot_index);
    });

    const a1primary = document.querySelector('#a1-row-' + assignmentId + ' .a1-presenter-primary');
    if (a1primary) a1primary.textContent = data.presenter_name || 'â€” Unassigned â€”';

    // FIX: update photo zone to show the new active slot's photo
    const zone = document.getElementById('photo-zone-' + assignmentId);
    if (zone && data.slot_id) {
        // Re-wire click and file input to the new slot
        zone.setAttribute('onclick', 'triggerPhotoForSlot(' + data.slot_id + ', ' + assignmentId + ')');
        const fileInput = zone.querySelector('.a2-photo-input');
        if (fileInput) {
            fileInput.id = 'photo-input-slot-' + data.slot_id;
            fileInput.setAttribute('onchange', 'uploadPhotoForSlot(' + data.slot_id + ', ' + assignmentId + ', this)');
        }

        // Update displayed photo
        const placeholder = document.getElementById('photo-placeholder-' + assignmentId);
        let img = document.getElementById('photo-img-' + assignmentId);

        if (data.photo_url) {
            if (placeholder) placeholder.style.display = 'none';
            if (!img) {
                img = document.createElement('img');
                img.id = 'photo-img-' + assignmentId;
                img.style.cssText = 'width:70px;height:70px;object-fit:cover;border-radius:5px;display:block;';
                zone.insertBefore(img, zone.firstChild);
            }
            img.style.display = 'block';
            img.src = data.photo_url;

            let expandDiv = document.getElementById('photo-expand-' + assignmentId);
            if (!expandDiv) {
                const wrapper = document.createElement('div');
                wrapper.className = 'a2-photo-expand';
                const expandImg = document.createElement('img');
                expandImg.id = 'photo-expand-' + assignmentId;
                wrapper.appendChild(expandImg);
                zone.appendChild(wrapper);
                expandDiv = expandImg;
            }
            expandDiv.src = data.photo_url;
        } else {
            // No photo for this slot â€” show placeholder
            if (img) img.style.display = 'none';
            const expandWrapper = zone.querySelector('.a2-photo-expand');
            if (expandWrapper) expandWrapper.style.display = 'none';
            if (placeholder) placeholder.style.display = '';
        }
    }
}

// â”€â”€ Close input blur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('focusout', function(e) {
    if (e.target.classList.contains('a2-presenter-input')) {
        setTimeout(() => {
            document.querySelectorAll('.presenter-dropdown').forEach(d => d.classList.remove('open'));
        }, 200);
    }
});

// â”€â”€ Close modal on background click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('group-manage-modal').addEventListener('mousedown', function(e) {
    if (e.target === this) closeGroupManager();
});
</script>

{% endblock %}