<!-- planner/templates/planner/mic_tracker.html -->
{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Mic Tracker - {{ show_info.show_name|default:"Audio Patch" }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'admin/css/mic_tracker.css' %}">
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <script src="{% static 'admin/js/jquery.init.js' %}"></script>
{% endblock %}

{% block content %}
<div id="mic-tracker-container">
    <!-- Header Section -->
    <div class="mic-tracker-header">
        <h1>Mic Assignment Tracker</h1>
        
        <div class="show-info">
            <div class="info-row">
                <span class="label">Show:</span>
                <span class="value">{{ show_info.show_name|default:"--" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Venue:</span>
                <span class="value">{{ show_info.venue_name|default:"--" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Ballroom:</span>
                <span class="value">{{ show_info.ballroom_name|default:"--" }}</span>
            </div>
            <div class="info-row">
                <span class="label">Duration:</span>
                <span class="value">{{ show_info.duration_display|default:"--" }}</span>
            </div>
        </div>
        
        <div class="tracker-actions">
            {% if not is_viewer %}
            <button class="btn btn-primary" onclick="addNewDay()">Add Day</button>
            {% endif %}
            <button class="btn btn-secondary" onclick="expandAllDays()">Expand All</button>
            <button class="btn btn-secondary" onclick="collapseAllDays()">Collapse All</button>
            <a href="/audiopatch/mic-tracker/export/" class="btn btn-export">Export CSV</a>
        </div>

    <!-- Days Container -->
    <div class="days-container">
        {% for day_data in days_data %}
        <div class="day-section" data-day-id="{{ day_data.day.id }}" data-collapsed="{{ day_data.day.is_collapsed|yesno:'true,false' }}">
            <div class="day-header" onclick="toggleDay({{ day_data.day.id }})">
                <span class="collapse-icon">{% if day_data.day.is_collapsed %}‚ñ∂{% else %}‚ñº{% endif %}</span>
                <h2>{{ day_data.day }}</h2>
                <div class="day-stats">
                    {% with stats=day_data.day.get_all_mics_status %}
                    <span class="stat">Sessions: {{ day_data.day.sessions.count }}</span>
                    <span class="stat">Mics: {{ stats.used }}/{{ stats.total }}</span>
                    <span class="stat">Available: {{ stats.available }}</span>
                    {% endwith %}
                </div>
                <div class="day-actions">
                    {% if not is_viewer %}
                    <button class="btn btn-sm" onclick="event.stopPropagation(); addSession({{ day_data.day.id }})">Add Session</button>
                    {% endif %}
                </div>
            </div>
            
            <div class="day-content" {% if day_data.day.is_collapsed %}style="display: none;"{% endif %}>
                <div class="sessions-grid">
                    {% for session in day_data.sessions %}
                        {% if forloop.counter0|divisibleby:3 %}
                            {% if not forloop.first %}</div>{% endif %}
                            <div class="session-row">
                        {% endif %}
                        
                        <div class="session-column" data-session-id="{{ session.id }}">
                            <div class="session-header">
                                <div class="session-info">
                                    <span class="session-date">{{ session.day.date|date:"m/d" }}</span>
                                    <h3>{{ session.name }}</h3>
                                    {% if session.location %}
                                    <span class="session-location">{{ session.location }}</span>
                                    {% endif %}
                                </div>
                                <div class="session-actions">
                                    {% if not is_viewer %}
                                    <button class="btn-icon" title="Duplicate" onclick="duplicateSession({{ session.id }})">üìã</button>
                                    <button class="btn-icon" title="Settings" onclick="editSession({{ session.id }})">‚öôÔ∏è</button>
                                    <div class="dropdown">
                                        <button class="btn-icon" title="Bulk Actions">‚ãÆ</button>
                                        <div class="dropdown-content">
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'check_all_micd'); return false;">Check All MIC'D</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'uncheck_all_micd'); return false;">Uncheck All MIC'D</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'check_all_dmic'); return false;">Check All D-MIC</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'uncheck_all_dmic'); return false;">Uncheck All D-MIC</a>
                                            <a href="#" onclick="bulkUpdate({{ session.id }}, 'clear_all'); return false;">Clear All</a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div> 
                            
                            <div class="mic-grid">
                                <div class="mic-grid-header">
                                    <div class="col-rf">RF#</div>
                                    <div class="col-type">TYPE</div>
                                    <div class="col-presenter">PRESENTER</div>
                                    <div class="col-micd">MIC'D</div>
                                    <div class="col-dmic">D-MIC</div>
                                </div>
                                
                                {% for assignment in session.mic_assignments.all %}
                                <div class="mic-row {% if assignment.is_micd %}is-micd{% endif %}" data-assignment-id="{{ assignment.id }}">
                                    <div class="col-rf">{{ assignment.rf_number|stringformat:"02d" }}</div>
                                    
                                    <div class="col-type">
                                        <select class="mic-type-select" onchange="updateField({{ assignment.id }}, 'mic_type', this.value)" {% if is_viewer %}disabled{% endif %}>
                                            <option value="">---</option>
                                            {% for value, label in mic_types %}
                                            {% if value %}
                                            <option value="{{ value }}" {% if assignment.mic_type == value %}selected{% endif %}>{{ label }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-presenter">
                                        <!-- Primary Presenter Row -->
                                        <div class="presenter-row primary-presenter">
                                            <span class="presenter-order">1¬∞</span>
                                            <input type="text" 
                                                    class="presenter-input {% if assignment.active_presenter_index == 0 %}active-presenter{% endif %}" 
                                                    value="{% if assignment.presenter %}{{ assignment.presenter.name }}{% endif %}"
                                                    placeholder="Enter name..."
                                                    list="presenters-datalist"
                                                    onchange="updateField({{ assignment.id }}, 'presenter', this.value)"
                                                    title="Primary presenter"
                                                    {% if is_viewer %}readonly{% endif %}>


                                            {% if not is_viewer %}
                                            <!-- Add Shared Presenter Button -->
                                            <button type="button" 
                                                    class="btn-add-shared" 
                                                    onclick="togglePresenters({{ assignment.id }})"
                                                    title="Add shared presenter">
                                                +
                                            </button>
                                            {% endif %}
                                            
                                            
                                            <!-- Expand/Collapse Button -->
                                            {% if assignment.shared_presenters.exists %}
                                                <button type="button" 
                                                        class="btn-expand-presenters" 
                                                        onclick="togglePresenters({{ assignment.id }})"
                                                        title="Show shared presenters">
                                                    <span class="expand-icon">‚ñ∂</span>
                                                    <span class="presenter-count">+{{ assignment.shared_presenters.count }}</span>
                                                </button>
                                            {% if not is_viewer %}
                                            <button type="button" 
                                                    class="btn-remove-presenter" 
                                                    onclick="removeSharedPresenter({{ assignment.id }}, '{{ shared.name }}')"
                                                    title="Remove presenter">
                                                √ó
                                            </button>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Shared Presenters Expandable Section -->
                                        <div class="shared-presenters-container" style="display: none;" data-assignment-id="{{ assignment.id }}">
                                            {% for shared in assignment.shared_presenters.all %}
                                            <div class="presenter-row shared-presenter" data-presenter-name="{{ shared.name }}">
                                                <span class="presenter-order">{{ forloop.counter|add:"1" }}¬∞</span>
                                                <input type="text" 
                                                       class="presenter-input {% if assignment.active_presenter_index == forloop.counter %}active-presenter{% endif %}" 
                                                       value="{{ shared.name }}"
                                                       readonly
                                                       title="Shared presenter #{{ forloop.counter|add:"1" }}">
                                                {% if assignment.active_presenter_index == forloop.counter %}
                                                <span class="current-badge">CURRENT</span>
                                                {% endif %}
                                                <button type="button" 
                                                        class="btn-remove-presenter" 
                                                        onclick="removeSharedPresenter({{ assignment.id }}, '{{ shared.name }}')"
                                                        title="Remove presenter">
                                                    √ó
                                                </button>
                                            </div>
                                            {% endfor %}
                                            
                                            <!-- Add New Presenter Form -->
                                            {% if not is_viewer %}
                                            <!-- Add New Presenter Form -->
                                            <div class="add-presenter-row">
                                                <input type="text" 
                                                        class="presenter-input add-presenter-input" 
                                                        placeholder="Add presenter..."
                                                        id="newPresenter_{{ assignment.id }}"
                                                        list="presenters-datalist"
                                                        onkeypress="if(event.key === 'Enter') addSharedPresenterInline({{ assignment.id }})">
                                                <button type="button" 
                                                        class="btn-add-inline" 
                                                        onclick="addSharedPresenterInline({{ assignment.id }})"
                                                        title="Add presenter">
                                                    +
                                                </button>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Reset Button (only show if not on primary) -->
                                            {% if assignment.active_presenter_index > 0 %}
                                            <div class="reset-row">
                                                <button type="button" 
                                                        class="btn-reset-rotation" 
                                                        onclick="resetPresenterRotation({{ assignment.id }})"
                                                        title="Reset to primary presenter">
                                                    ‚Ü∫ Reset to Primary
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-micd">
                                        <input type="checkbox" 
                                            class="mic-checkbox"
                                            {% if assignment.is_micd %}checked{% endif %}
                                            onchange="updateField({{ assignment.id }}, 'is_micd', this.checked)"
                                            {% if is_viewer %}disabled{% endif %}>
                                    </div>

                                    <div class="col-dmic">
                                        <input type="checkbox" 
                                            class="mic-checkbox dmic-checkbox"
                                            {% if assignment.is_d_mic %}checked{% endif %}
                                            onchange="handleDmicChange({{ assignment.id }}, this.checked)"
                                            {% if is_viewer %}disabled{% endif %}>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="session-footer">
                                {% with stats=session.get_mic_usage_stats %}
                                <span class="session-stat">MIC'D: {{ stats.micd }}/{{ stats.total }}</span>
                                <span class="session-stat">Available: {{ stats.total|add:stats.micd|stringformat:"-d" }}</span>
                                {% if stats.shared > 0 %}
                                <span class="session-stat">Shared: {{ stats.shared }}</span>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                        
                        {% if forloop.last %}</div>{% endif %}
                    {% endfor %}
                    
                    
                    
                    {% if not is_viewer %}
                        {% if not day_data.sessions %}
                            <div class="session-row">
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 0)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 1)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 2)">
                                        + Add Session
                                    </button>
                                </div>
                            </div>
                        {% elif day_data.sessions|length|divisibleby:3 %}
                            <div class="session-row">
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 0)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 1)">
                                        + Add Session
                                    </button>
                                </div>
                                <div class="session-column empty">
                                    <button class="btn btn-ghost" onclick="addSession({{ day_data.day.id }}, 2)">
                                        + Add Session
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Close the for day_data in days_data loop -->

                <!-- Shared datalist for all presenter inputs -->
                    <datalist id="presenters-datalist">
                        <!-- Will be populated by JavaScript -->
                    </datalist>

                    <script src="{% static 'admin/js/mic_tracker.js' %}"></script>
                    {% endblock %}
            