{% load custom_tags chunk_filters %}
{% load i18n admin_urls static admin_modify chunk_filters %}
<style>
  .device-output-cell {
    padding: 5px;  /* Reduced from 10px */
    border: 1px solid #ddd;
    text-align: center;
    width: 12.5%;  /* Force consistent width for 8 columns */
  }
  .device-output-cell .number {
    font-weight: bold;
    margin-bottom: 5px;  /* Reduced from 8px */
    font-size: 13px;  /* Slightly smaller */
  }
  .device-output-cell .select {
    margin-top: 3px;  /* Reduced from 5px */
  }
  .device-output-cell select {
    width: 100%;
    font-size: 12px;  /* Smaller font in dropdown */
  }
</style>

<div class="js-inline-admin-formset inline-group">
  <div class="tabular inline-related">
    {{ inline_admin_formset.formset.management_form }}

    <fieldset class="module {{ inline_admin_formset.classes }}">
      <h2>{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>

      <table class="dynamic-deviceoutput_set" width="100%" cellspacing="0">
        <tbody>
          {% for form_chunk in inline_admin_formset.forms|chunk:8 %}
            <tr class="form-row">
              {% for form in form_chunk %}
                <td class="device-output-cell">
                  {# hidden PK/FK fields etc. #}
                  {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                  {% endfor %}
                  {{ form.output_number.as_hidden }}
                  
                  {# Hidden signal_name field #}
                  <input type="hidden" name="{{ form.signal_name.html_name }}" 
                         id="{{ form.signal_name.id_for_label }}" 
                         value="{{ form.signal_name.value|default:'' }}">

                  {# Output number #}
                  <div class="number">
                    {% if form.instance.output_number %}
                      Out {{ form.instance.output_number }}
                    {% elif form.initial.output_number %}
                      Out {{ form.initial.output_number }}
                    {% else %}
                      Out {{ forloop.parentloop.counter0|multiply:8|add:forloop.counter }}
                    {% endif %}
                  </div>

                  {# Console output dropdown #}
                  <div class="select">
                    {{ form.console_output }}
                  </div>
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </fieldset>
  </div>
</div>