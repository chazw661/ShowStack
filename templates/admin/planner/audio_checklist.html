{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Dark theme styling matching your system */
    #content {
        background-color: #1a1a1a;
        padding: 0;
    }

    .checklist-container {
        background-color: #1a1a1a;
        color: #e0e0e0;
        padding: 20px;
        min-height: calc(100vh - 100px);
    }

    .checklist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #444;
    }

    .checklist-header h1 {
        color: #4a9eff;
        margin: 0;
        font-size: 1.8rem;
    }

    .project-name {
        color: #ffc107;
        font-size: 1rem;
        margin-top: 5px;
    }

    .back-link {
        background-color: #333;
        color: #4a9eff;
        padding: 8px 16px;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .back-link:hover {
        background-color: #444;
        color: #6ab7ff;
    }

    .controls {
        margin-bottom: 30px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }

    .btn {
        background-color: #4a9eff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .btn:hover {
        background-color: #3a8eef;
        transform: translateY(-1px);
    }

    .btn.danger {
        background-color: #f44336;
    }

    .btn.danger:hover {
        background-color: #d32f2f;
    }

    .btn:disabled {
        background-color: #666;
        cursor: not-allowed;
        transform: none;
    }

    select {
        background-color: #333;
        color: #e0e0e0;
        border: 1px solid #444;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
    }

    .checklist-section {
        margin-bottom: 40px;
        background-color: #2a2a2a;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .section-header {
        background-color: #333;
        padding: 15px;
        margin: -20px -20px 20px -20px;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
        font-size: 1.5rem;
        color: #4a9eff;
        font-weight: 600;
    }

    .checklist-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .checklist-table th {
        background-color: #333;
        color: #e0e0e0;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border: 1px solid #444;
    }

    .checklist-table th[style*="ffc107"] {
        color: #000 !important;
        font-size: 14px;
        font-weight: 700;
    }

    .checklist-table td {
        padding: 10px;
        border: 1px solid #444;
        vertical-align: middle;
    }

    .task-input {
        width: 100%;
        padding: 6px;
        background-color: #333;
        color: #e0e0e0;
        border: 1px solid #444;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .task-input.status-not-started {
        background-color: rgba(33, 150, 243, 0.3);
        color: #e0e0e0;
        border: 1px solid #2196F3;
    }

    .task-input.status-in-progress {
        background-color: rgba(255, 193, 7, 0.3);
        color: #e0e0e0;
        border: 1px solid #FFC107;
    }

    .task-input.status-trouble-shooting {
        background-color: rgba(244, 67, 54, 0.3);
        color: #e0e0e0;
        border: 1px solid #f44336;
    }

    .task-input.status-complete {
        background-color: rgba(76, 175, 80, 0.3);
        color: #e0e0e0;
        border: 1px solid #4CAF50;
    }

    .task-input.status-na {
        background-color: rgba(117, 117, 117, 0.3);
        color: #e0e0e0;
        border: 1px solid #757575;
    }

    .stage-select, .status-select {
        width: 100%;
        padding: 6px;
        background-color: #333;
        color: #e0e0e0;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
    }

    tr.status-not-started {
        background-color: rgba(244, 67, 54, 0.1);
    }

    tr.status-in-progress {
        background-color: rgba(255, 193, 7, 0.1);
    }

    tr.status-complete {
        background-color: rgba(76, 175, 80, 0.1);
    }

    tr.status-na {
        background-color: rgba(96, 125, 139, 0.1);
    }

    .delete-btn {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }

    .day-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .day-checkbox:checked {
        accent-color: #4CAF50;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-overlay.hidden {
        display: none;
    }

    .loading-spinner {
        color: #4a9eff;
        font-size: 24px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background-color: #4CAF50;
        color: white;
        border-radius: 4px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    }

    .notification.error {
        background-color: #f44336;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="checklist-container">
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner">Loading...</div>
    </div>

    <div class="checklist-header">
        <div>
            <h1>Audio Production Checklist</h1>
            <div class="project-name" id="projectName">Loading...</div>
        </div>
        <a href="{% url 'admin:index' %}" class="back-link">‚Üê Back to Admin</a>
    </div>
    
    <div class="controls">
        <button class="btn danger" onclick="resetAll()">üîÑ Reset All</button>
        <button class="btn" onclick="exportToCSV()">üìä Export to CSV</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
        <select id="dayFilter" onchange="filterByDay()">
            <option value="all">All Days</option>
            <option value="day1">Day 1</option>
            <option value="day2">Day 2</option>
            <option value="day3">Day 3</option>
            <option value="day4">Day 4</option>
        </select>
    </div>

    <div id="checklistContainer"></div>
</div>

<script>
// Get CSRF token for AJAX requests
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
}

let checklists = {};
let statuses = {};

function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.className = 'notification' + (isError ? ' error' : '');
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

async function loadData() {
    showLoading();
    try {
        const response = await fetch('{% url "planner:audio_checklist_data" %}');
        const data = await response.json();
        
        if (data.error) {
            showNotification(data.error, true);
            return;
        }
        
        checklists = data.checklists;
        statuses = data.statuses;
        document.getElementById('projectName').textContent = 'Project: ' + data.project_name;
        renderChecklists();
    } catch (error) {
        showNotification('Error loading data: ' + error.message, true);
    } finally {
        hideLoading();
    }
}

async function apiCall(url, data) {
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify(data),
        });
        const result = await response.json();
        if (result.error) {
            showNotification(result.error, true);
            return null;
        }
        return result;
    } catch (error) {
        showNotification('Error: ' + error.message, true);
        return null;
    }
}

function renderChecklists() {
    const container = document.getElementById('checklistContainer');
    container.innerHTML = '';

    Object.keys(checklists).forEach(sectionName => {
        const section = checklists[sectionName];
        const sectionStatuses = statuses[sectionName];
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'checklist-section';
        
        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
            <span class="section-title">${sectionName}</span>
            <div>
                <button class="btn" style="padding: 5px 15px; font-size: 12px; margin-right: 10px;" onclick="addSetupTask('${sectionName}')">+ Setup Task</button>
                <button class="btn" style="padding: 5px 15px; font-size: 12px;" onclick="addDailyTask('${sectionName}')">+ Daily Task</button>
            </div>
        `;
        sectionDiv.appendChild(header);

        // Create a two-column layout
        const layoutDiv = document.createElement('div');
        layoutDiv.style.display = 'flex';
        layoutDiv.style.gap = '20px';

        // Left column - Setup tasks (one-time)
        if (section.setup && section.setup.length > 0) {
            const setupDiv = document.createElement('div');
            setupDiv.style.flex = '0 0 40%';
            
            const setupHeader = document.createElement('h4');
            setupHeader.style.color = '#ffc107';
            setupHeader.style.backgroundColor = '#333';
            setupHeader.style.padding = '8px';
            setupHeader.style.marginBottom = '10px';
            setupHeader.style.borderRadius = '4px';
            setupHeader.textContent = 'Setup Tasks (One-Time)';
            setupDiv.appendChild(setupHeader);
            
            const setupTable = createSetupTable(sectionName, 'setup', section.setup, sectionStatuses.setup);
            setupDiv.appendChild(setupTable);
            layoutDiv.appendChild(setupDiv);
        }

        // Right column - Daily tasks
        if (section.daily && section.daily.length > 0) {
            const dailyDiv = document.createElement('div');
            dailyDiv.style.flex = '1';
            
            const dailyHeader = document.createElement('h4');
            dailyHeader.style.color = '#ffc107';
            dailyHeader.style.backgroundColor = '#333';
            dailyHeader.style.padding = '8px';
            dailyHeader.style.marginBottom = '10px';
            dailyHeader.style.borderRadius = '4px';
            dailyHeader.textContent = 'Daily Tasks';
            dailyDiv.appendChild(dailyHeader);
            
            const dailyTable = createDailyTable(sectionName, 'daily', section.daily, sectionStatuses.daily);
            dailyDiv.appendChild(dailyTable);
            layoutDiv.appendChild(dailyDiv);
        }

        sectionDiv.appendChild(layoutDiv);
        container.appendChild(sectionDiv);
    });
}

function createSetupTable(sectionName, type, tasks, taskStatuses) {
    const table = document.createElement('table');
    table.className = 'checklist-table';
    table.style.width = '100%';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th style="background-color: #ffc107; color: #000;">TASK</th>
        <th style="background-color: #000; color: #fff; width: 130px;">STAGE</th>
        <th style="background-color: #000; color: #fff; width: 120px;">STATUS</th>
        <th style="width: 60px;">Actions</th>
    `;
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    tasks.forEach((task, index) => {
        const row = createSetupRow(sectionName, type, task, taskStatuses[index]);
        tbody.appendChild(row);
    });
    table.appendChild(tbody);

    return table;
}

function createDailyTable(sectionName, type, tasks, taskStatuses) {
    const table = document.createElement('table');
    table.className = 'checklist-table';
    table.style.width = '100%';
    
    const thead = document.createElement('thead');
    
    // Day headers row
    const dayHeaderRow = document.createElement('tr');
    dayHeaderRow.innerHTML = `
        <th rowspan="2" style="background-color: #ffc107; color: #000; width: 300px;">TASK</th>
        <th style="background-color: #ffc107; color: #000;">Day 1 ${sectionName.split(' ')[0]}</th>
        <th style="background-color: #ffc107; color: #000;">Day 2 ${sectionName.split(' ')[0]}</th>
        <th style="background-color: #ffc107; color: #000;">Day 3 ${sectionName.split(' ')[0]}</th>
        <th style="background-color: #ffc107; color: #000;">Day 4 ${sectionName.split(' ')[0]}</th>
        <th rowspan="2" style="width: 60px;">Actions</th>
    `;
    thead.appendChild(dayHeaderRow);
    
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    tasks.forEach((task, index) => {
        const row = createDailyRow(sectionName, type, task, taskStatuses[index]);
        tbody.appendChild(row);
    });
    table.appendChild(tbody);

    return table;
}

function createSetupRow(sectionName, type, task, taskStatus) {
    const row = document.createElement('tr');
    const status = taskStatus.day1;
    
    row.className = `status-${status}`;
    row.dataset.taskId = task.id;

    row.innerHTML = `
        <td>
            <input type="text" class="task-input" value="${task.task}" 
                   onchange="updateTask(${task.id}, 'task', this.value)">
        </td>
        <td>
            <select class="stage-select" 
                    onchange="updateTask(${task.id}, 'stage', this.value)">
                <option value="" ${task.stage === '' ? 'selected' : ''}>-</option>
                <option value="Pre-Production" ${task.stage === 'Pre-Production' ? 'selected' : ''}>Pre-Production</option>
                <option value="Load-In" ${task.stage === 'Load-In' ? 'selected' : ''}>Load-In</option>
            </select>
        </td>
        <td>
            <select class="status-select" 
                    onchange="updateSetupStatus(${task.id}, this.value, this)">
                <option value="not-started" ${status === 'not-started' ? 'selected' : ''}>Not Started</option>
                <option value="in-progress" ${status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                <option value="complete" ${status === 'complete' ? 'selected' : ''}>Complete</option>
                <option value="na" ${status === 'na' ? 'selected' : ''}>N/A</option>
            </select>
        </td>
        <td>
            <button class="delete-btn" onclick="deleteTask(${task.id})">√ó</button>
        </td>
    `;
    
    return row;
}

function createDailyRow(sectionName, type, task, taskStatus) {
    const row = document.createElement('tr');
    row.dataset.taskId = task.id;
    
    row.innerHTML = `
        <td>
            <input type="text" class="task-input" value="${task.task}" 
                   onchange="updateTask(${task.id}, 'task', this.value)">
        </td>
        <td style="text-align: center;">
            <input type="checkbox" class="day-checkbox" 
                   ${taskStatus.day1 === 'complete' ? 'checked' : ''}
                   onchange="updateDayStatus(${task.id}, 'day1', this.checked)">
        </td>
        <td style="text-align: center;">
            <input type="checkbox" class="day-checkbox"
                   ${taskStatus.day2 === 'complete' ? 'checked' : ''}
                   onchange="updateDayStatus(${task.id}, 'day2', this.checked)">
        </td>
        <td style="text-align: center;">
            <input type="checkbox" class="day-checkbox"
                   ${taskStatus.day3 === 'complete' ? 'checked' : ''}
                   onchange="updateDayStatus(${task.id}, 'day3', this.checked)">
        </td>
        <td style="text-align: center;">
            <input type="checkbox" class="day-checkbox"
                   ${taskStatus.day4 === 'complete' ? 'checked' : ''}
                   onchange="updateDayStatus(${task.id}, 'day4', this.checked)">
        </td>
        <td>
            <button class="delete-btn" onclick="deleteTask(${task.id})">√ó</button>
        </td>
    `;
    
    return row;
}

async function updateTask(taskId, field, value) {
    const result = await apiCall('{% url "planner:audio_checklist_update_task" %}', {
        task_id: taskId,
        field: field,
        value: value,
    });
    if (result && result.success) {
        showNotification('Saved');
    }
}

async function updateSetupStatus(taskId, value, selectElement) {
    const result = await apiCall('{% url "planner:audio_checklist_update_status" %}', {
        task_id: taskId,
        day: 'day1',
        status: value,
    });
    if (result && result.success) {
        const row = selectElement.closest('tr');
        row.className = `status-${value}`;
        showNotification('Saved');
    }
}

async function updateDayStatus(taskId, day, checked) {
    const status = checked ? 'complete' : 'not-started';
    const result = await apiCall('{% url "planner:audio_checklist_update_status" %}', {
        task_id: taskId,
        day: day,
        status: status,
    });
    if (result && result.success) {
        showNotification('Saved');
    }
}

async function addSetupTask(sectionName) {
    const taskName = prompt('Enter setup task name:');
    if (taskName) {
        const result = await apiCall('{% url "planner:audio_checklist_add_task" %}', {
            checklist_name: sectionName,
            task_type: 'setup',
            task: taskName,
        });
        if (result && result.success) {
            await loadData();
            showNotification('Task added');
        }
    }
}

async function addDailyTask(sectionName) {
    const taskName = prompt('Enter daily task name:');
    if (taskName) {
        const result = await apiCall('{% url "planner:audio_checklist_add_task" %}', {
            checklist_name: sectionName,
            task_type: 'daily',
            task: taskName,
        });
        if (result && result.success) {
            await loadData();
            showNotification('Task added');
        }
    }
}

async function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        const result = await apiCall('{% url "planner:audio_checklist_delete_task" %}', {
            task_id: taskId,
        });
        if (result && result.success) {
            await loadData();
            showNotification('Task deleted');
        }
    }
}

async function resetAll() {
    if (confirm('This will reset all checklists to default. Are you sure?')) {
        showLoading();
        const result = await apiCall('{% url "planner:audio_checklist_reset" %}', {});
        if (result && result.success) {
            await loadData();
            showNotification('Reset to defaults');
        }
        hideLoading();
    }
}

function exportToCSV() {
    let csv = 'Section,Type,Task,Stage,Day 1,Day 2,Day 3,Day 4\n';
    
    Object.keys(checklists).forEach(sectionName => {
        const section = checklists[sectionName];
        const sectionStatuses = statuses[sectionName];
        
        ['setup', 'daily'].forEach(type => {
            section[type].forEach((task, index) => {
                const taskStatus = sectionStatuses[type][index];
                csv += `"${sectionName}","${type}","${task.task}","${task.stage || ''}",`;
                csv += `"${taskStatus.day1}","${taskStatus.day2}","${taskStatus.day3}","${taskStatus.day4}"\n`;
            });
        });
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audio_checklist_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    showNotification('Exported to CSV');
}

function filterByDay() {
    const filter = document.getElementById('dayFilter').value;
    const tables = document.querySelectorAll('.checklist-table');
    
    tables.forEach(table => {
        const headers = table.querySelectorAll('thead th');
        const rows = table.querySelectorAll('tbody tr');
        
        if (filter === 'all') {
            headers.forEach(th => th.style.display = '');
            rows.forEach(row => {
                row.querySelectorAll('td').forEach(td => td.style.display = '');
            });
        } else {
            const dayNum = filter.replace('day', '');
            headers.forEach((th, index) => {
                if (index <= 1 || index === parseInt(dayNum) + 1 || index === 6) {
                    th.style.display = '';
                } else {
                    th.style.display = 'none';
                }
            });
            rows.forEach(row => {
                row.querySelectorAll('td').forEach((td, index) => {
                    if (index <= 1 || index === parseInt(dayNum) + 1 || index === 6) {
                        td.style.display = '';
                    } else {
                        td.style.display = 'none';
                    }
                });
            });
        }
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    loadData();
});
</script>
{% endblock %}