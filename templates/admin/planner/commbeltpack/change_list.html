{% extends "admin/change_list.html" %}


{% block object-tools-items %}
    <!-- Export PDF Button -->
    <li>
        <a href="{% url 'planner:all_comm_beltpacks_pdf_export' %}" class="viewlink" target="_blank">
            Export PDF
        </a>
    </li>
    {{ block.super }}
{% endblock %}

{% block result_list %}
<div class="comm-summary" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
    
    <!-- Left side: Belt Pack Summary -->
    <div style="flex: 1; min-width: 280px;">
        <h3>Belt Pack Summary</h3>
        
        <div class="system-section wireless-section">
            <h4>ðŸ“» Wireless System</h4>
            <div class="stats">
                <span class="stat">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">{{ wireless_total }}</span>
                </span>
                <span class="stat">
                    <span class="stat-label">Checked Out:</span>
                    <span class="stat-value">{{ wireless_checked }}</span>
                </span>
                <span class="stat">
                    <span class="stat-label">Available:</span>
                    <span class="stat-value">{{ wireless_available }}</span>
                </span>
            </div>
            
            {% if wireless_groups %}
            <div class="group-stats">
                <span class="stat-label">By Group:</span>
                {% for group, count in wireless_groups.items %}
                <span class="stat mini">
                    <span class="stat-label">{{ group }}:</span>
                    <span class="stat-value">{{ count }}</span>
                </span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <div class="system-section hardwired-section">
            <h4>ðŸ”Œ Hardwired System</h4>
            <div class="stats">
                <span class="stat">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">{{ hardwired_total }}</span>
                </span>
            </div>
            
            {% if hardwired_groups %}
            <div class="group-stats">
                <span class="stat-label">By Group:</span>
                {% for group, count in hardwired_groups.items %}
                <span class="stat mini">
                    <span class="stat-label">{{ group }}:</span>
                    <span class="stat-value">{{ count }}</span>
                </span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right side: Quick Links -->
    <div style="display: flex; flex-direction: column; gap: 12px; min-width: 200px;">
        <h3 style="margin: 0 0 4px 0; font-size: 13px; text-transform: uppercase; color: #888; letter-spacing: 1px;">Manage</h3>
        <a href="../commposition/" class="comm-nav-btn">
            <span class="comm-nav-icon">ðŸ“‹</span>
            <span class="comm-nav-label">Positions</span>
        </a>
        <a href="../commcrewname/" class="comm-nav-btn">
            <span class="comm-nav-icon">ðŸ‘¤</span>
            <span class="comm-nav-label">Crew Names</span>
        </a>
        <a href="../commchannel/" class="comm-nav-btn">
            <span class="comm-nav-icon">ðŸ“¡</span>
            <span class="comm-nav-label">Channels</span>
        </a>
    </div>
</div>

<!-- Channel Assignment Popup Modal -->
<div id="channel-popup-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
    <div id="channel-popup" style="background:#1e1e2e; border:1px solid #3a5068; border-radius:10px; padding:0; min-width:320px; max-width:420px; max-height:70vh; display:flex; flex-direction:column; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
        <div style="padding:14px 18px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <span id="channel-popup-title" style="font-weight:600; font-size:14px; color:#e0e0e0;">Assign Channel</span>
            <span id="channel-popup-close" style="cursor:pointer; color:#888; font-size:18px; padding:0 4px;">&times;</span>
        </div>
        <div id="channel-popup-list" style="overflow-y:auto; padding:8px; flex:1;">
            <div style="color:#888; text-align:center; padding:20px;">Loading...</div>
        </div>
    </div>
</div>

{{ block.super }}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
/* Comm Navigation Buttons */
.comm-nav-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    background: linear-gradient(135deg, #1a2a3a 0%, #243447 100%);
    border: 1px solid #3a5068;
    border-radius: 8px;
    color: #e0e0e0;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    min-width: 180px;
}

.comm-nav-btn:hover {
    background: linear-gradient(135deg, #243447 0%, #2d4a63 100%);
    border-color: #4a9eff;
    color: #ffffff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.15);
}

.comm-nav-icon {
    font-size: 18px;
    width: 28px;
    text-align: center;
}

.comm-nav-label {
    font-weight: 600;
    letter-spacing: 0.3px;
}

/* Channel badge hover effect */
.ch-badge {
    transition: all 0.15s ease;
}
.ch-badge:hover {
    transform: scale(1.08);
    box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
    filter: brightness(1.2);
}

/* Channel popup option buttons */
.ch-popup-option {
    display: block;
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 4px;
    background: #252540;
    border: 1px solid #333;
    border-radius: 6px;
    color: #e0e0e0;
    font-size: 13px;
    text-align: left;
    cursor: pointer;
    transition: all 0.15s ease;
}
.ch-popup-option:hover {
    background: #2d4a63;
    border-color: #4a9eff;
    color: #fff;
}
.ch-popup-option.active {
    background: #14b8a6;
    color: #000;
    border-color: #14b8a6;
    font-weight: 600;
}
.ch-popup-unassign {
    display: block;
    width: 100%;
    padding: 10px 14px;
    margin-top: 8px;
    background: #3a1a1a;
    border: 1px solid #662222;
    border-radius: 6px;
    color: #ff6666;
    font-size: 13px;
    text-align: left;
    cursor: pointer;
    transition: all 0.15s ease;
}
.ch-popup-unassign:hover {
    background: #4a2020;
    border-color: #ff4444;
}

/* Collapsible group headers */
.system-group-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 12px 20px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    border-left: 4px solid #3498db;
    margin-top: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
}

.system-group-header.wireless {
    border-left-color: #3498db;
}

.system-group-header.hardwired {
    border-left-color: #e67e22;
}

.system-group-header:hover {
    background: linear-gradient(135deg, #34495e 0%, #3d566e 100%);
}

.system-group-header .toggle-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.system-group-header.collapsed .toggle-icon {
    transform: rotate(-90deg);
}

.system-group-header .count-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 10px;
}

/* Hide collapsed rows */
tr.system-row.hidden {
    display: none !important;
}
</style>

<script>
django.jQuery(document).ready(function($) {
    // ========== CHANNEL ASSIGNMENT POPUP ==========
    var $overlay = $('#channel-popup-overlay');
    var $popupList = $('#channel-popup-list');
    var $popupTitle = $('#channel-popup-title');
    var currentBpcId = null;
    var currentBadge = null;
    var channelsCache = null;

    // Fetch channels once and cache
    function loadChannels(callback) {
        if (channelsCache) {
            callback(channelsCache);
            return;
        }
        $.getJSON('get-channels/', function(data) {
            channelsCache = data.channels;
            callback(channelsCache);
        });
    }

    // Open popup when clicking a channel badge
    $(document).on('click', '.ch-badge', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        currentBpcId = $(this).data('bpc-id');
        currentBadge = $(this);
        var chNum = $(this).data('ch-num');
        
        $popupTitle.text('Assign Channel ' + chNum);
        $popupList.html('<div style="color:#888; text-align:center; padding:20px;">Loading...</div>');
        $overlay.css('display', 'flex');
        
        loadChannels(function(channels) {
            var html = '';
            
            // Get current channel text to highlight active
            var currentText = currentBadge.text().split(': ')[1] || '';
            
            for (var i = 0; i < channels.length; i++) {
                var ch = channels[i];
                var isActive = (currentText.trim() === ch.abbreviation) ? ' active' : '';
                html += '<button class="ch-popup-option' + isActive + '" data-channel-id="' + ch.id + '">' + 
                    '<strong>' + ch.abbreviation + '</strong> &mdash; ' + ch.name + 
                    '</button>';
            }
            
            // Add unassign option
            html += '<button class="ch-popup-unassign" data-channel-id="">âœ• Unassign Channel</button>';
            
            $popupList.html(html);
        });
    });

    // Handle channel selection
    $(document).on('click', '.ch-popup-option, .ch-popup-unassign', function() {
        var channelId = $(this).data('channel-id');
        
        // Get CSRF token
        var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
        if (!csrfToken) {
            var cookieMatch = document.cookie.match(/csrftoken=([^;]+)/);
            csrfToken = cookieMatch ? cookieMatch[1] : '';
        }
        
        $.ajax({
            url: 'assign-channel/',
            method: 'POST',
            contentType: 'application/json',
            headers: {'X-CSRFToken': csrfToken},
            data: JSON.stringify({
                beltpack_channel_id: currentBpcId,
                channel_id: channelId || null
            }),
            success: function(data) {
                if (data.success) {
                    var chNum = data.channel_number;
                    if (data.abbreviation) {
                        currentBadge
                            .text(chNum + ': ' + data.abbreviation)
                            .css({background: '#14b8a6', color: '#000'})
                            .removeClass('unassigned').addClass('assigned');
                    } else {
                        currentBadge
                            .html(chNum + ': &mdash;')
                            .css({background: '#333', color: '#666'})
                            .removeClass('assigned').addClass('unassigned');
                    }
                    $overlay.hide();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                alert('Error saving channel assignment');
            }
        });
    });

    // Close popup
    $('#channel-popup-close').on('click', function() {
        $overlay.hide();
    });
    $overlay.on('click', function(e) {
        if (e.target === this) {
            $overlay.hide();
        }
    });
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') $overlay.hide();
    });

    // ========== SYSTEM TYPE GROUPING ==========
    var $table = $('#result_list');
    var $tbody = $table.find('tbody');
    
    var wirelessRows = [];
    var hardwiredRows = [];
    
    $tbody.find('tr').each(function() {
        var $row = $(this);
        var rowText = $row.text();
        
        if (rowText.indexOf('W-') !== -1 || rowText.indexOf('ðŸ“¡') !== -1) {
            wirelessRows.push($row);
            $row.addClass('system-row wireless-row');
        } 
        else if (rowText.indexOf('H-') !== -1 || rowText.indexOf('ðŸ”Œ') !== -1) {
            hardwiredRows.push($row);
            $row.addClass('system-row hardwired-row');
        }
    });
    
    if (wirelessRows.length === 0 && hardwiredRows.length === 0) {
        return;
    }
    
    function createGroupHeader(title, type, count) {
        var $header = $('<tr class="system-group-header-row ' + type + '">')
            .html(
                '<td colspan="20" style="padding: 0; border: none;">' +
                    '<div class="system-group-header ' + type + '" data-group="' + type + '">' +
                        '<span>' +
                            '<span class="toggle-icon">â–¼</span> ' +
                            title +
                            '<span class="count-badge">' + count + '</span>' +
                        '</span>' +
                    '</div>' +
                '</td>'
            );
        return $header;
    }
    
    $tbody.empty();
    
    if (wirelessRows.length > 0) {
        var $wirelessHeader = createGroupHeader('ðŸ“¡ Wireless System', 'wireless', wirelessRows.length);
        $tbody.append($wirelessHeader);
        $.each(wirelessRows, function(i, row) {
            $tbody.append(row);
        });
    }
    
    if (hardwiredRows.length > 0) {
        var $hardwiredHeader = createGroupHeader('ðŸ”Œ Hardwired System', 'hardwired', hardwiredRows.length);
        $tbody.append($hardwiredHeader);
        $.each(hardwiredRows, function(i, row) {
            $tbody.append(row);
        });
    }
    
    $tbody.on('click', '.system-group-header', function() {
        var $header = $(this);
        var groupType = $header.data('group');
        var $rows = $tbody.find('tr.' + groupType + '-row');
        
        $header.toggleClass('collapsed');
        
        if ($header.hasClass('collapsed')) {
            $rows.addClass('hidden');
        } else {
            $rows.removeClass('hidden');
        }
    });
});
</script>
{% endblock %}