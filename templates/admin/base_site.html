{% extends "admin/base.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
/* Override Django's link colors - loaded AFTER Django's CSS */
:root,
html[data-theme="dark"],
html[data-theme="auto"] {
    --link-fg: #ffffff !important;
    --link-hover-color: #00ff88 !important;
    --link-selected-fg: #00ff88 !important;
}

/* Admin index page - force white links */
.app-list a,
.app-list th a,
#content-main a {
    color: #ffffff !important;
}

.app-list a:hover,
.app-list th a:hover,
#content-main a:hover {
    color: #00ff88 !important;
}
</style>
{% endblock %}

{% block branding %}
<div id="branding-wrapper" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 20px;">
    <h1 id="site-name">
    <a href="{% url 'admin:index' %}" style="display: flex; align-items: center; gap: 10px;">
        <img src="{% static 'admin/img/showstack_icon.svg' %}" alt="ShowStack" height="32" style="vertical-align: middle;">
        <span><span style="color: #4a9eff;">ShowStack</span> Administration</span>
    </a>
</h1>
    <div class="dashboard-nav" style="display: flex; gap: 10px; align-items: center;">
        <a href="{% url 'dashboard' %}" class="dashboard-button" style="
            background: linear-gradient(135deg, #1a7a6f 0%, #0d5c54 100%);
            color: #fff !important;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(26, 122, 111, 0.4);
        ">
            ðŸ“Š Dashboard
        </a>
    </div>
</div>

<style>
.dashboard-button {
    color: #fff !important;
}

.dashboard-button:hover {
    background: linear-gradient(135deg, #2a9d8f 0%, #1a7a6f 100%) !important;
    box-shadow: 0 4px 12px rgba(42, 157, 143, 0.6) !important;
    transform: translateY(-2px);
    color: #fff !important;
}

.dashboard-button:link,
.dashboard-button:visited,
.dashboard-button:active {
    color: #fff !important;
}

/* Mobile responsive */
@media (max-width: 768px) {
    #branding-wrapper {
        flex-direction: column !important;
        gap: 10px;
    }
    
    .dashboard-nav {
        width: 100%;
        justify-content: center;
    }
}
</style>

{% endblock %}

{% block userlinks %}
    <!-- User Role Badge -->
    {% if user.is_authenticated %}
        <span style="display: inline-block; margin-right: 15px;">
            <span style="color: #fff; margin-right: 8px;">{{ user.username }}</span>
            {% if user.is_superuser %}
                <span style="background: #e74c3c; color: white; padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: bold;">SUPERUSER</span>
            {% elif user_role == 'owner' %}
                <span style="background: #3498db; color: white; padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: bold;">OWNER</span>
            {% elif user_role == 'editor' %}
                <span style="background: #f39c12; color: white; padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: bold;">EDITOR</span>
            {% elif user_role == 'viewer' %}
                <span style="background: #95a5a6; color: white; padding: 4px 10px; border-radius: 3px; font-size: 11px; font-weight: bold;">VIEWER</span>
            {% endif %}
        </span>
    {% endif %}
    
    <!-- Project Switcher (for superusers and owners) or Static Display (for editors/viewers) -->
    {% if show_project_dropdown %}
        <div style="display: inline-block; margin-right: 20px;">
            <label for="project-switcher" style="color: #fff; margin-right: 10px;">ðŸ”§ Project:</label>
            <select id="project-switcher" style="padding: 5px 10px; background: #2a2a2a; color: #fff; border: 1px solid #4a9eff; border-radius: 4px; font-size: 14px;">
                <option value="">-- Select Project --</option>
                {% for project in user_projects %}
                    <option value="{{ project.id }}" {% if current_project and project.id == current_project.id %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% elif current_project %}
        <!-- Static project display for editors/viewers -->
        <div style="display: inline-block; margin-right: 20px; padding: 5px 15px; background: #0f3460; border: 1px solid #4ecca3; border-radius: 4px;">
            <span style="color: #95a5a6; font-size: 13px; margin-right: 8px;">ðŸ”§ Project:</span>
            <span style="color: #4ecca3; font-weight: 600; font-size: 14px;">{{ current_project.name }}</span>
        </div>
    {% endif %}
    
    {{ block.super }}
{% endblock %}


{% block extrahead %}
{{ block.super }}



<!-- Collapsible Sidebar Menu -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Define parent-child relationships
    const menuStructure = {
        'Comm Belt Packs': ['Comm Positions', 'Comm Channels', 'Comm Crew Names'],
        'Show Mic Tracker': ['Mic Sessions', 'Mic Assignments', 'Presenters', 'Mic Show Information'],
        'Soundvision Predictions': ['Speaker Arrays', 'Speaker Cabinets'],
        'Power Distribution Plans': ['Amplifiers in Power Plan', 'Amplifier Profiles']
    };
    
    // Find the sidebar
    const sidebar = document.getElementById('nav-sidebar');
    if (!sidebar) return;
    
    // Get saved state from localStorage
    const savedState = JSON.parse(localStorage.getItem('sidebarState') || '{}');
    
    // Get all rows in the sidebar
    const allRows = sidebar.querySelectorAll('tr');
    
    // Build a map of link text to row(s) - handle duplicates by storing arrays
    const rowMap = {};
    allRows.forEach(row => {
        const link = row.querySelector('a:not(.addlink)');
        if (link) {
            const text = link.textContent.trim().toLowerCase();
            if (!rowMap[text]) {
                rowMap[text] = [];
            }
            rowMap[text].push({ row: row, link: link });
        }
    });
    
    // Process each parent
    Object.entries(menuStructure).forEach(([parent, children]) => {
        const parentLower = parent.toLowerCase();
        const parentEntries = rowMap[parentLower];
        
        if (!parentEntries || parentEntries.length === 0) return;
        
        // Use the first matching parent
        const parentRow = parentEntries[0].row;
        const parentLink = parentEntries[0].link;
        
        // Collect ALL matching child rows
        const childRows = [];
        children.forEach(childName => {
            const childLower = childName.toLowerCase();
            const childEntries = rowMap[childLower];
            if (childEntries) {
                childEntries.forEach(entry => {
                    childRows.push(entry.row);
                    // Style child
                    entry.row.classList.add('menu-child-item');
                });
            }
        });
        
        if (childRows.length === 0) return;
        
        // Create arrow
        const arrow = document.createElement('span');
        arrow.className = 'menu-toggle-arrow';
        arrow.innerHTML = 'â–¶';
        parentLink.insertBefore(arrow, parentLink.firstChild);
        parentLink.style.fontWeight = 'bold';
      
        
        // Set initial state
        const isCollapsed = savedState[parent] !== false;
        
        function updateDisplay(collapsed) {
            if (collapsed) {
                arrow.style.transform = 'rotate(0deg)';
                childRows.forEach(row => {
                    row.style.setProperty('display', 'none', 'important');
                });
            } else {
                arrow.style.transform = 'rotate(90deg)';
                childRows.forEach(row => {
                    row.style.setProperty('display', 'block', 'important');
                });
            }
        }
        
        // Apply initial state
        updateDisplay(isCollapsed);
        
        // Toggle function
        function toggleChildren(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const currentlyCollapsed = childRows[0].style.display === 'none';
            const newState = !currentlyCollapsed;
            
            updateDisplay(newState);
            
            // Save state
            savedState[parent] = newState;
            localStorage.setItem('sidebarState', JSON.stringify(savedState));
        }
        
        // Click handlers
        arrow.addEventListener('click', toggleChildren);
        parentLink.addEventListener('dblclick', toggleChildren);
    });
    
    // Add CSS
    const style = document.createElement('style');
    style.textContent = `
        /* Make all sidebar links uppercase by default */
        #nav-sidebar th a {
            text-transform: uppercase !important;
            font-weight: bold !important;
        }
        /* Override for child items - normal case */
        .menu-child-item th a {
            text-transform: none !important;
            font-weight: normal !important;
        }
        .menu-child-item td,
        .menu-child-item th {
            padding-left: 20px !important;
        }
        .menu-child-item a::before {
            content: 'â”” ';
            color: #555;
            font-size: 11px;
        }
        .menu-toggle-arrow {
            color: #888;
            font-size: 10px;
            transition: transform 0.2s;
            display: inline-block;
            cursor: pointer;
            width: 16px;
            margin-left: -20px;
            margin-right: 4px;
            text-align: center;
        }
        #nav-sidebar th a,
        #nav-sidebar td a {
            display: inline-block;
        }
        .menu-toggle-arrow:hover {
            color: #00ff88 !important;
        }
        #nav-sidebar table {
            width: 100%;
        }
    `;
    document.head.appendChild(style);
    
    console.log('âœ… Collapsible sidebar menu initialized');
});
</script>





<!-- Favicon and App Icons -->
<link rel="icon" type="image/png" sizes="32x32" href="{% static 'admin/img/favicon_32x32.png' %}">
<link rel="icon" type="image/png" sizes="16x16" href="{% static 'admin/img/favicon_16x16.png' %}">
<link rel="apple-touch-icon" sizes="180x180" href="{% static 'admin/img/icon_180x180.png' %}">

<!-- Force dark theme for all users -->
<script>
    // Run immediately to prevent flash of light theme
    (function() {
        document.documentElement.setAttribute('data-theme', 'dark');
    })();
    
    // Also set after DOM loads in case Django tries to override
    document.addEventListener('DOMContentLoaded', function() {
        document.documentElement.setAttribute('data-theme', 'dark');
    });
</script>

    {% if user_role == 'viewer' %}
<style>
/* Disable child menu items for viewers */
.model-commposition a,
.model-commcrewname a,
.model-commchannel a,
.model-pafanout a,
.model-micsession a,
.model-micassignment a,
.model-presenter a,
.model-micshowinfo a,
.model-speakerarray a,
.model-speakercabinet a,
.model-amplifierassignment a,
.model-amplifierprofile a,
.model-p1input a,
.model-p1output a,
.model-galaxyinput a,
.model-galaxyoutput a {
    pointer-events: none !important;
    opacity: 0.4 !important;
    cursor: not-allowed !important;
    color: #666 !important;
}
</style>
{% endif %}

<style>
/* Override Django's CSS variables for links */
:root,
html[data-theme="dark"],
html[data-theme="auto"] {
    --link-fg: #ffffff !important;
    --link-hover-color: #00ff88 !important;
    --link-selected-fg: #00ff88 !important;
}

/* Hide the System Dashboard button in the admin index */
.object-tools a[href*="dashboard"],
a[href*="system-dashboard"],
a.button[href*="dashboard"] {
    display: none !important;
}


/* Hide related widget buttons in Comm Belt Pack list view */
body.app-planner.model-commbeltpack #changelist .related-widget-wrapper .change-related,
body.app-planner.model-commbeltpack #changelist .related-widget-wrapper .delete-related,
body.app-planner.model-commbeltpack #changelist .related-widget-wrapper .view-related,
body.app-planner.model-commbeltpack #changelist .related-widget-wrapper .add-related {
    display: none !important;
}

/* Inline dark theme with maximum specificity */
html, body {
    background: #0a0a0a !important;
}

body, #container, #content, #content-main, .main, .content, .colMS, .colM {
    background-color: #0a0a0a !important;
    color: #e0e0e0 !important;
}

/* Header */
#header {
    background: #1a1a1a !important;
    color: #e0e0e0 !important;
}

#branding h1, #branding h1 a:link, #branding h1 a:visited {
    color: #00ff88 !important;
}

#user-tools a {
    color: #e0e0e0 !important;
    border-bottom-color: #333 !important;
}

/* Breadcrumbs */
div.breadcrumbs {
    background: #1a1a1a !important;
    color: #e0e0e0 !important;
}

div.breadcrumbs a {
    color: #00ff88 !important;
}

/* Modules and fieldsets */
.module, fieldset, .inline-group {
    background: #1a1a1a !important;
    border: 1px solid #333 !important;
}

.module h2, .module caption, fieldset h2 {
    background: #252525 !important;
    color: #e0e0e0 !important;
}

/* Form inputs */
input[type="text"], input[type="password"], input[type="email"], 
input[type="url"], input[type="number"], input[type="tel"],
select, textarea {
    background-color: #000 !important;
    color: #fff !important;
    border: 1px solid #444 !important;
}

input:focus, select:focus, textarea:focus {
    border-color: #00ff88 !important;
    outline: 2px solid #00ff88 !important;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.3) !important;
}

/* Tables */
#changelist, #result_list {
    background: #0f0f0f !important;
}

#result_list thead th {
    background: #1a1a1a !important;
    color: #e0e0e0 !important;
    border-bottom: 1px solid #333 !important;
}

#result_list tbody tr {
    background: #0f0f0f !important;
    border-bottom: 1px solid #222 !important;
}

#result_list tbody tr:nth-child(even) {
    background: #1a1a1a !important;
}

#result_list tbody tr:hover {
    background: #252525 !important;
}

#result_list tbody td, #result_list tbody th {
    color: #e0e0e0 !important;
    border-bottom: 1px solid #222 !important;
}

/* Sidebar */
#changelist-filter {
    background: #0f0f0f !important;
    border-left: 1px solid #333 !important;
}

#changelist-filter h2, #changelist-filter h3 {
    color: #e0e0e0 !important;
}

#changelist-filter li {
    color: #e0e0e0 !important;
}

#changelist-filter a {
    color: #4da6ff !important;
}

/* Buttons */
.button, input[type="submit"], input[type="button"], 
.submit-row input, a.button {
    background: #417690 !important;
    color: #fff !important;
    border: none !important;
}

.button:hover, input[type="submit"]:hover, input[type="button"]:hover,
.submit-row input:hover, a.button:hover {
    background: #205067 !important;
}

/* Default button (save) */
.default, input[type="submit"].default {
    background: #00ff88 !important;
    color: #000 !important;
}

.default:hover, input[type="submit"].default:hover {
    background: #00cc6a !important;
}

/* ========================================
   ADMIN INDEX PAGE - MODULE LINKS
   ======================================== */

/* Admin index module links - white text with maximum specificity */
#content-main .app-list a,
#content-main .app-list a:link,
#content-main .app-list a:visited,
.app-list table a,
.app-list table a:link,
.app-list table a:visited,
.app-list tr th a,
.app-list tr th a:link,
.app-list tr th a:visited,
.model-list a,
.model-list a:link,
.model-list a:visited,
table.app-list th a,
table.app-list th a:link,
table.app-list th a:visited {
    color: #ffffff !important;
}

#content-main .app-list a:hover,
.app-list table a:hover,
.app-list tr th a:hover,
.model-list a:hover,
table.app-list th a:hover {
    color: #00ff88 !important;
}

/* Section titles on index page */
.app-list .section h2,
.module caption {
    background: #252525 !important;
    color: #f0f0f0 !important;
}

/* ========================================
   NAVIGATION SIDEBAR - COMPREHENSIVE FIX
   ======================================== */

/* Sidebar container */
#nav-sidebar {
    background: #0f0f0f !important;
}

/* Current app/model highlighting */
#nav-sidebar .current-app,
#nav-sidebar .current-model {
    background: #1a1a1a !important;
}

/* ALL sidebar links - white text */
#nav-sidebar a,
#nav-sidebar a:link,
#nav-sidebar a:visited {
    color: #ffffff !important;
    padding-right: 50px !important;
}

/* Sidebar links hover - bright green */
#nav-sidebar a:hover,
#nav-sidebar a:focus {
    color: #00ff88 !important;
}

/* Current/active page - bright green */
#nav-sidebar .current a,
#nav-sidebar .current a:link,
#nav-sidebar .current a:visited {
    color: #00ff88 !important;
    font-weight: bold;
}

/* App labels and model labels */
#nav-sidebar .app-label,
#nav-sidebar .model-label {
    color: #f0f0f0 !important;
}

/* Section headers in sidebar */
#nav-sidebar .module th,
#nav-sidebar .module caption,
#nav-sidebar h2,
#nav-sidebar h3 {
    background: #1a1a1a !important;
    color: #f0f0f0 !important;
}

/* Add links in sidebar - keep hidden */
#nav-sidebar .addlink {
    display: none !important;
}

/* Add link hover override */
#nav-sidebar .addlink:hover {
    background: #f5f5f5 !important;
    color: #205067 !important;
}

/* Sidebar list items */
#nav-sidebar li {
    position: relative !important;
    color: #e0e0e0 !important;
}

/* Sidebar text elements */
#nav-sidebar span,
#nav-sidebar .caption {
    color: #e0e0e0 !important;
}

/* Delete buttons */
.deletelink, .deletelink-box a {
    background: #cc0000 !important;
    color: #fff !important;
}

.deletelink:hover {
    background: #ff3838 !important;
}

/* Messages */
.messagelist li {
    background: #1a1a1a !important;
    color: #e0e0e0 !important;
}

.messagelist .success {
    background: #1a4d1a !important;
    border-color: #00ff88 !important;
}

.messagelist .warning {
    background: #4d4d1a !important;
}

.messagelist .error {
    background: #4d1a1a !important;
}

/* Links */
a, a:link, a:visited {
    color: #4da6ff !important;
}

a:hover {
    color: #00ff88 !important;
}

a:focus, a:active {
    color: #00ff88 !important;
}

/* General text */
label, p, li, dt, dd, th, td, h1, h2, h3, h4, h5 {
    color: #e0e0e0 !important;
}

.help, .helptext, .grp-description {
    color: #999 !important;
}

/* Tabs */
.module h2, .inline-group h2 {
    cursor: pointer !important;
}

/* Checkboxes and radio buttons */
input[type="checkbox"], input[type="radio"] {
    filter: invert(1) hue-rotate(180deg) !important;
}

/* Calendar widget */
.calendarbox, .clockbox {
    background: #1a1a1a !important;
    border: 1px solid #333 !important;
}

.calendar caption, .calendarbox h2 {
    background: #252525 !important;
    color: #e0e0e0 !important;
}

.calendar td, .calendar th {
    background: #0f0f0f !important;
    border: 1px solid #333 !important;
}

.calendar td a {
    color: #4da6ff !important;
}

.calendar td.selected a {
    background: #00ff88 !important;
    color: #000 !important;
}

/* Object tools */
.object-tools {
    background: transparent !important;
}

.object-tools li {
    background: transparent !important;
    border: none !important;
}

.object-tools a {
    color: #e0e0e0 !important;
}

/* History button */
.historylink, 
a.historylink,
input[name="_history"],
.submit-row .historylink,
.object-tools .historylink {
    background: #444 !important;
    color: #fff !important;
    border: 1px solid #666 !important;
}

.historylink:hover,
a.historylink:hover {
    background: #666 !important;
    color: #fff !important;
}

.historylink::before,
.historylink::after {
    display: none !important;
}


/* Smaller Dante Number fields */
input[name*="dante_number"] {
    width: 60px !important;
    max-width: 60px !important;
    text-align: center !important;
}

/*FIX FOR MAKING CELLS LARGER TO FIT IN ROWS

/* Make inline form inputs fill more of the cell space */
.inline-group table select,
.inline-group table input[name*="name"],
.inline-group table input[name*="destination"],
.inline-group table textarea {
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Add padding to inline table cells */
.inline-group table td {
    padding: 4px 6px !important;
}

/* Make inputs taller to fill rows */
.inline-group table input,
.inline-group table select {
    padding: 8px 10px !important;
    height: auto !important;
}

/* Make inputs taller to fill rows */
.inline-group table input,
.inline-group table select {
    padding: 8px 10px !important;
    height: auto !important;
}

/* Hide original object labels in tabular inlines */
.inline-group .tabular td.original,
.inline-group .tabular td.original p,
.inline-group .tabular th.original {
    display: none !important;
    width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden !important;
}








/* Color-coded Fixed/Variable dropdowns */
select.bus-type-fixed {
    background-color: #2a4a2a !important;
    color: #90ee90 !important;
    border-color: #90ee90 !important;
}

select.bus-type-variable {
    background-color: #4a2a2a !important;
    color: #ff9090 !important;
    border-color: #ff9090 !important;
}
</style>

<!-- Spreadsheet Navigation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Spreadsheet navigation loading...');
    
    if (!document.body.classList.contains('change-form')) {
        console.log('Not a change form, skipping navigation');
        return;
    }
    
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && 
                e.target.tagName !== 'TEXTAREA' &&
                e.target.type !== 'submit' &&
                e.target.type !== 'button') {
                
                e.preventDefault();
                e.stopPropagation();
                
                const inputs = Array.from(form.querySelectorAll(
                    'input:not([type="hidden"]):not([readonly]):not([disabled]):not([type="submit"]):not([type="button"]), ' +
                    'select:not([disabled]), ' +
                    'textarea:not([readonly]):not([disabled])'
                )).filter(el => el.offsetParent !== null);
                
                const current = inputs.indexOf(e.target);
                if (current === -1) return false;
                
                let next;
                if (e.shiftKey) {
                    next = current - 1;
                    if (next < 0) next = inputs.length - 1;
                } else {
                    next = current + 1;
                    if (next >= inputs.length) next = 0;
                }
                
                if (inputs[next]) {
                    inputs[next].focus();
                    if (inputs[next].select && inputs[next].type !== 'select-one') {
                        setTimeout(() => inputs[next].select(), 10);
                    }
                }
                
                return false;
            }
        });
    });
    
    console.log('âœ… Spreadsheet navigation active - Enter: next, Shift+Enter: previous');
});
</script>

<!-- Project Switcher -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Project switcher loaded');
    const switcher = document.getElementById('project-switcher');
    if (switcher) {
        console.log('Switcher found, adding listener');
        switcher.addEventListener('change', function() {
            const newProjectId = this.value;
            console.log('Switching to project:', newProjectId);
            
            // Simple direct navigation - let the view handle redirect
            window.location.href = '/audiopatch/switch-project/' + newProjectId + '/';
        });
    } else {
        console.log('Switcher NOT found');
    }
});
</script>

<!-- Color-coded Fixed/Variable dropdowns -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    function colorBusTypeDropdowns() {
        document.querySelectorAll('select[name*="bus_type"]').forEach(function(select) {
            updateSelectColor(select);
            
            select.addEventListener('change', function() {
                updateSelectColor(this);
            });
        });
    }
    
    function updateSelectColor(select) {
        select.classList.remove('bus-type-fixed', 'bus-type-variable');
        if (select.value === 'Fixed') {
            select.classList.add('bus-type-fixed');
        } else if (select.value === 'Variable') {
            select.classList.add('bus-type-variable');
        }
    }
    
    colorBusTypeDropdowns();
    
    if (typeof django !== 'undefined' && django.jQuery) {
        django.jQuery(document).on('formset:added', function() {
            setTimeout(colorBusTypeDropdowns, 100);
        });
    }
});
</script>

{% endblock %}